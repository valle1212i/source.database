<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="payments-base" content="https://stripe-payment-oversvamningsskydd-kund1.onrender.com">

  <title>Kundportal – Betalningar</title>

  <link rel="stylesheet" href="CSS/betalningar.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- SIDOMENY -->
<div class="sidebar">
  <div class="logo">
    <a href="customerportal.html">
      <img src="Images/logo.png" alt="Logotyp" class="logo-img" />
    </a>
  </div>
  <ul class="nav-menu">
    <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
    <li class="active"><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
    <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
    <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
    <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
    <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
    <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
    <li><a href="marknadsforing.html"><i class="fas fa-bullhorn"></i> Marknadsföring</a></li>
    <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
    <li><a href="installningar.html"><i class="fas fa-cog"></i> Inställningar</a></li>
  </ul>
  <div class="help">
    <a href="faq.html"><i class="fas fa-question-circle"></i> Hjälp</a>
  </div>
</div>

<!-- HAMBURGERMENY (mobil) -->
<button id="menuToggle" class="hamburger-menu" aria-label="Visa meny">
  &#9776;
</button>

<!-- PROFILMENY -->
<div class="profile-wrapper">
  <div class="profile-icon" id="profileToggle">--</div>
  <div class="profile-dropdown" id="profileMenu">
    <div class="profile-email" id="userEmail">Laddar...</div>
    <hr />
    <a href="#" id="switchAccount">Byt konto</a>
    <a href="#" id="openSettings">Profilinställningar</a>
    <a href="#" id="logout">Logga ut</a>
  </div>
</div>

<!-- HUVUDINNEHÅLL -->
<main class="main">
  <h1>Betalningar</h1>
  <a href="customerportal.html" class="back-button">← Tillbaka till översikt</a>
  <p class="info-text">Hantera dina senaste transaktioner nedan.</p>

  <div class="filters">
    <input type="text" id="searchInput" placeholder="Sök e-post, transaktions-ID eller session-ID...">
    <select id="statusFilter">
      <option value="all">Alla</option>
      <option value="paid">Paid</option>
      <option value="unpaid">Unpaid</option>
      <option value="processing">Processing</option>
      <option value="requires_payment_method">Requires payment method</option>
    </select>
    <input type="date" id="startDate">
    <button class="black-button" id="filterBtn">Filtrera</button>
    <button class="black-button" id="sortBtn">Sortera efter datum</button>
    <button class="black-button" id="reloadBtn">Ladda om</button>
  </div>

  <div id="paymentsList" aria-live="polite"></div>

  <div id="receiptModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="receiptTitle">
    <div class="modal-content">
      <button class="close" aria-label="Stäng" onclick="closeModal()">&times;</button>
      <h2 id="receiptTitle">Transaktionsdetaljer</h2>
      <div id="modalDetails"></div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="black-button" id="pdfBtn">Exportera kvitto som PDF</button>
        <button class="black-button" id="refundBtn">Återbetala</button>
      </div>
    </div>
  </div>
</main>

<!-- SCRIPT: Funktionalitet -->
<script>
  /* ================== CSRF helper ================== */
  let CSRF_TOKEN = null;
  async function getCsrfToken() {
    if (CSRF_TOKEN) return CSRF_TOKEN;
    const r = await fetch('/csrf-token', { credentials: 'include' });
    const d = await r.json();
    CSRF_TOKEN = d.csrfToken;
    return CSRF_TOKEN;
  }

  // ---------------- Hjälpare ----------------
  function formatCurrency(amount, currency) {
    if (!Number.isFinite(amount)) return '';
    const cur = (currency || 'SEK').toUpperCase();
    const value = amount / 100;
    try {
      return new Intl.NumberFormat('sv-SE', { style: 'currency', currency: cur }).format(value);
    } catch { return `${value.toFixed(2)} ${cur}`; }
  }
  function formatDate(ts) {
    if (!ts) return '';
    const d = typeof ts === 'number' ? new Date(ts) : new Date(ts);
    return d.toLocaleString('sv-SE', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  }
  function obfuscateCard(pm = {}) {
    const brand = (pm.card_brand || pm.brand || '').toUpperCase();
    const last4 = pm.card_last4 || pm.last4 || '';
    if (!brand && !last4) return '';
    return `${brand ? brand : 'Kort'} ${last4 ? '**** ' + last4 : ''}`.trim();
  }
  function safeText(el, text) {
    while (el.firstChild) el.removeChild(el.firstChild);
    el.appendChild(document.createTextNode(String(text ?? '')));
  }

  // --- Logo för PDF ---
  let LOGO_DURL = null;
  async function loadLogoDataUrl(src = 'Images/logo.png') {
    if (LOGO_DURL) return LOGO_DURL;
    const res = await fetch(src, { credentials: 'same-origin' });
    const blob = await res.blob();
    LOGO_DURL = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
    return LOGO_DURL;
  }

  // ---------------- State ----------------
  let allPayments = [];
  let currentReceipt = null;
  let sortAsc = false;

  // ---------------- Render ----------------
  function renderList(list) {
    const wrap = document.getElementById('paymentsList');
    while (wrap.firstChild) wrap.removeChild(wrap.firstChild);

    if (!list || list.length === 0) {
      const empty = document.createElement('p');
      empty.className = 'info-text';
      empty.textContent = 'Inga betalningar hittades.';
      wrap.appendChild(empty);
      return;
    }

    list.forEach(p => {
      const card = document.createElement('div');
      card.className = 'card';

      const top = document.createElement('div');
      top.className = 'card-top';

      const left = document.createElement('div');
      const strong = document.createElement('strong');
      const orderId = p.sessionId || p.payment_intent_id || p._id || '';
      safeText(strong, `Order ${orderId ? '#' + orderId : ''}`);
      const amount = document.createElement('p');
      amount.className = 'amount';
      amount.textContent = formatCurrency(p.amount_total ?? p.amount ?? 0, p.currency);

      left.appendChild(strong);
      left.appendChild(amount);

      const statusDiv = document.createElement('div');
      const paid = (p.payment_status || '').toLowerCase() === 'paid';
      statusDiv.className = 'status ' + (paid ? 'open' : 'progress');
      const i = document.createElement('i');
      i.className = paid ? 'fas fa-check-circle' : 'fas fa-hourglass-half';
      statusDiv.appendChild(i);
      statusDiv.appendChild(document.createTextNode(' ' + (p.payment_status || 'okänt')));

      top.appendChild(left);
      top.appendChild(statusDiv);

      const details = document.createElement('div');
      details.className = 'card-details';
      const cardRow = document.createElement('p');
      cardRow.textContent = 'Kort: ' + obfuscateCard(p.payment_method_details || {});
      const dateRow = document.createElement('p');
      dateRow.textContent = 'Datum: ' + formatDate(p.stripe_created_ms || p.created || Date.now());
      const txnRow = document.createElement('p');
      txnRow.textContent = 'Transaktions-ID: ' + (p.payment_intent_id || '');

      details.appendChild(cardRow);
      details.appendChild(dateRow);
      details.appendChild(txnRow);

      const actions = document.createElement('div');
      actions.className = 'actions';

      const btn = document.createElement('button');
      btn.className = 'black-button';
      btn.textContent = 'Visa detaljer';
      btn.addEventListener('click', () => {
  if (!p.sessionId) return alert('Saknar sessionId');
  window.location.href = `betalning.html?session=${encodeURIComponent(p.sessionId)}`;
});
      actions.appendChild(btn);

      const rBtn = document.createElement('button');
      rBtn.className = 'black-button';
      rBtn.textContent = 'Återbetala';
      rBtn.addEventListener('click', () => {
        requestRefund(p.sessionId || '', p.amount_total ?? p.amount ?? 0);
      });
      actions.appendChild(rBtn);

      card.appendChild(top);
      card.appendChild(details);
      card.appendChild(actions);
      wrap.appendChild(card);
    });
  }

  function normalizeForReceipt(p) {
    const amount = p.amount_total ?? p.amount ?? 0;
    const currency = (p.currency || 'SEK').toUpperCase();
    const created = p.stripe_created_ms || p.created || Date.now();
    const order = p.sessionId || p.payment_intent_id || p._id || '';
    const status = p.payment_status || 'okänt';
    const email = p.customer_email || '';
    const card = obfuscateCard(p.payment_method_details || {});
    const id = p.payment_intent_id || '';
    const metadata = p.metadata || {};
    const line_items = Array.isArray(p.line_items) ? p.line_items : [];
    return {
      order, amount: formatCurrency(amount, currency), status, card,
      date: new Date(created).toLocaleDateString('sv-SE'),
      time: new Date(created).toLocaleTimeString('sv-SE', { hour:'2-digit', minute:'2-digit' }),
      id,
      email,
      currency,
      amount_total: amount,
      metadata,
      line_items
    };
  }

  function showReceipt(payment) {
    currentReceipt = payment;

    const details = document.getElementById("modalDetails");
    while (details.firstChild) details.removeChild(details.firstChild);

    const rows = [
      ["Order:", `#${String(payment.order ?? "")}`],
      ["Belopp:", String(payment.amount ?? "")],
      ["Status:", String(payment.status ?? "")],
      ["Kort:", String(payment.card ?? "")],
      ["Kund-e-post:", String(payment.email ?? "")],
      ["Datum & Tid:", `${String(payment.date ?? "")}, kl. ${String(payment.time ?? "")}`],
      ["Transaktions-ID:", String(payment.id ?? "")]
    ];

    for (const [label, value] of rows) {
      const p = document.createElement("p");
      const strong = document.createElement("strong");
      strong.appendChild(document.createTextNode(label + " "));
      p.appendChild(strong);
      p.appendChild(document.createTextNode(value));
      details.appendChild(p);
    }

    if (Array.isArray(payment.line_items) && payment.line_items.length) {
      const h = document.createElement('h3');
      h.textContent = 'Varor';
      details.appendChild(h);
      payment.line_items.forEach((li, i) => {
        const row = document.createElement('p');
        const nm = li?.description || li?.name || `Rad ${i+1}`;
        const qty = li?.quantity || 1;
        const unit = (li?.unit_amount ?? li?.amount_subtotal ?? 0);
        const ccy = (payment.currency || 'SEK').toUpperCase();
        row.textContent = `• ${nm} — ${qty} st, ${formatCurrency(unit, ccy)}`;
        details.appendChild(row);
      });
    }

    if (payment.metadata && Object.keys(payment.metadata).length) {
      const h = document.createElement('h3');
      h.textContent = 'Metadata';
      details.appendChild(h);
      for (const [k,v] of Object.entries(payment.metadata)) {
        const row = document.createElement('p');
        row.textContent = `• ${k}: ${String(v)}`;
        details.appendChild(row);
      }
    }

    const modal = document.getElementById("receiptModal");
    modal.style.display = "block";
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeModal() {
    const modal = document.getElementById("receiptModal");
    modal.style.display = "none";
    modal.setAttribute('aria-hidden', 'true');
    currentReceipt = null;
  }

  // --- PDF med logotyp uppe till vänster ---
  async function exportReceiptAsPDF() {
    if (!currentReceipt) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    try {
      const logo = await loadLogoDataUrl('Images/logo.png');
      doc.addImage(logo, 'PNG', 15, 10, 25, 0);
    } catch (e) {
      console.warn('Kunde inte ladda logotypen för PDF:', e);
    }

    doc.setFontSize(16);
    doc.text("Kvitto", 45, 20);
    doc.setFontSize(12);

    const lines = [
      `Order: #${currentReceipt.order || ''}`,
      `Belopp: ${currentReceipt.amount || ''}`,
      `Status: ${currentReceipt.status || ''}`,
      `Kort: ${currentReceipt.card || ''}`,
      `Kund-e-post: ${currentReceipt.email || ''}`,
      `Transaktions-ID: ${currentReceipt.id || ''}`
    ];

    let y = 35;
    lines.forEach(t => { doc.text(t, 20, y); y += 8; });

    if (Array.isArray(currentReceipt.line_items) && currentReceipt.line_items.length) {
      y += 4;
      doc.text('Varor:', 20, y); y += 8;
      currentReceipt.line_items.forEach((li, i) => {
        const nm = li?.description || li?.name || `Rad ${i+1}`;
        const qty = li?.quantity || 1;
        const amt = (li?.unit_amount ?? li?.amount_subtotal ?? 0) / 100;
        const currency = (currentReceipt.currency || 'SEK').toUpperCase();
        doc.text(`• ${nm} — ${qty} st, ${amt.toFixed(2)} ${currency}`, 20, y);
        y += 7;
      });
    }

    if (currentReceipt.metadata && Object.keys(currentReceipt.metadata).length) {
      y += 4;
      doc.text('Metadata:', 20, y); y += 8;
      Object.entries(currentReceipt.metadata).forEach(([k, v]) => {
        doc.text(`• ${k}: ${String(v)}`, 20, y);
        y += 7;
      });
    }

    const safeOrder = String(currentReceipt.order || 'order');
    doc.save(`Kvitto_${safeOrder}.pdf`);
  }

  /* ================== ÅTERBETALNING (med CSRF) ================== */
  // Bas-URL för betalningsservern (hämtas från <meta>)
const PAYMENTS_BASE =
  (document.querySelector('meta[name="payments-base"]')?.content || '').replace(/\/$/, '');
  async function requestRefund(sessionId, amountTotalOre) {
    if (!sessionId) return alert("Hittar inget sessionId på betalningen.");
    

    const amountStr = prompt("Belopp att återbetala i SEK (lämna tomt för full återbetalning):", "");
    let amountOre = null;
    if (amountStr && amountStr.trim() !== "") {
      const parsed = parseFloat(amountStr.replace(",", "."));
      if (!isFinite(parsed) || parsed <= 0) return alert("Ogiltigt belopp.");
      amountOre = Math.round(parsed * 100);
      if (amountOre > amountTotalOre) {
        if (!confirm("Beloppet överstiger ursprungsbeloppet. Återbetala hela beloppet istället?")) return;
        amountOre = null; // full refund
      }
    }
    const reason = prompt("Orsak (t.ex. requested_by_customer, duplicate, fraudulent). Lämna tomt för standard:", "") || "";

    if (!confirm("Bekräfta återbetalning" + (amountOre ? ` av ${formatCurrency(amountOre, 'SEK')}` : " (full)") + ".")) {
      return;
    }

    try {
  const base = PAYMENTS_BASE;
  if (!base) {
    alert("Kunde inte skapa återbetalning: PAYMENTS_BASE saknas eller är ogiltig");
    return;
  }

  const res = await fetch(`${base}/api/payments/refund`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }, // inga CSRF/credentials här
    body: JSON.stringify({
      sessionId,
      amount: amountOre ?? undefined,
      reason: reason || undefined
    })
  });

  const data = await res.json().catch(() => ({}));
  if (!res.ok || data.success === false) {
    throw new Error(data?.message || `Återbetalning misslyckades (${res.status})`);
  }

  alert("Återbetalning skapad ✅");
  reloadPayments();
} catch (err) {
  console.error("Refund error:", err);
  alert("Kunde inte skapa återbetalning: " + (err.message || "okänt fel"));
}
  }

  // ---------------- Filters ----------------
  function applyFilters() {
    const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
    const status = document.getElementById('statusFilter').value || 'all';
    const start = document.getElementById('startDate').value;

    let list = [...allPayments];
    if (q) {
      list = list.filter(p => {
        const email = (p.customer_email || '').toLowerCase();
        const pi = (p.payment_intent_id || '').toLowerCase();
        const sid = (p.sessionId || '').toLowerCase();
        return email.includes(q) || pi.includes(q) || sid.includes(q);
      });
    }
    if (status !== 'all') {
      list = list.filter(p => (p.payment_status || '').toLowerCase() === status);
    }
    if (start) {
      const startTs = new Date(start + 'T00:00:00').getTime();
      list = list.filter(p => {
        const t = p.stripe_created_ms || p.created || 0;
        return t >= startTs;
      });
    }
    renderList(list);
  }

  function sortByDate() {
    sortAsc = !sortAsc;
    allPayments.sort((a, b) => {
      const ta = a.stripe_created_ms || a.created || 0;
      const tb = b.stripe_created_ms || b.created || 0;
      return sortAsc ? (ta - tb) : (tb - ta);
    });
    applyFilters();
  }

  async function reloadPayments() {
    try {
      const res = await fetch('/api/payments?limit=200', { credentials: 'include' });
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error(data?.message || 'Kunde inte hämta betalningar');
      }
      allPayments = Array.isArray(data) ? data : (data.items || []);
      allPayments.sort((a, b) => (b.stripe_created_ms || b.created || 0) - (a.stripe_created_ms || a.created || 0));
      renderList(allPayments);
    } catch (e) {
      console.error('Fel vid hämtning av betalningar:', e);
      const wrap = document.getElementById('paymentsList');
      while (wrap.firstChild) wrap.removeChild(wrap.firstChild);
      const err = document.createElement('p');
      err.className = 'info-text';
      err.textContent = 'Kunde inte hämta betalningar. Försök igen senare.';
      wrap.appendChild(err);
    }
  }

  // ---------------- Profil/meny ----------------
  const toggle = document.getElementById('profileToggle');
  const menu = document.getElementById('profileMenu');

  toggle.addEventListener('click', () => {
    const isOpen = menu.style.display === 'flex';
    menu.style.display = isOpen ? 'none' : 'flex';
    toggle.classList.toggle('open', !isOpen);
  });

  window.addEventListener('click', function (e) {
    if (!document.querySelector('.profile-wrapper').contains(e.target)) {
      menu.style.display = 'none';
      toggle.classList.remove('open');
    }
  });

  document.getElementById("switchAccount").addEventListener("click", function (e) {
    e.preventDefault();
    if (confirm("Vill du logga ut och byta konto?")) {
      window.location.href = "login.html";
    }
  });

  document.getElementById("openSettings").addEventListener("click", function (e) {
    e.preventDefault();
    window.location.href = "profile.html";
  });

  document.getElementById("logout").addEventListener("click", function (e) {
    e.preventDefault();
    if (confirm("Är du säker på att du vill logga ut?")) {
      fetch('/logout', { method: 'GET', credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            localStorage.clear();
            window.location.href = "/login.html";
          } else {
            alert("Utloggning misslyckades.");
          }
        })
        .catch(err => {
          console.error("Fel vid utloggning:", err);
          alert("Kunde inte logga ut.");
        });
    }
  });

  async function loadUserProfile() {
    try {
      const res = await fetch("/api/profile/me", { credentials: 'include' });
      const data = await res.json();

      if (data.success) {
        const name = data.name || '';
        const email = data.email || '';
        const image = data.profileImage;

        const container = document.getElementById("profileToggle");
        while (container.firstChild) container.removeChild(container.firstChild);

        if (image) {
          const img = document.createElement("img");
          img.src = image;
          img.alt = "Profilbild";
          img.style.width = "32px";
          img.style.height = "32px";
          img.style.borderRadius = "50%";
          container.appendChild(img);
        } else {
          const initials = (name || "")
            .split(" ")
            .map(part => part.charAt(0).toUpperCase())
            .join("")
            .substring(0, 2);
          container.textContent = initials || "--";
        }

        document.getElementById("userEmail").textContent = email;
      } else {
        document.getElementById("profileToggle").textContent = "??";
        document.getElementById("userEmail").textContent = "Ej inloggad";
      }
    } catch (err) {
      console.error("Fel vid hämtning av användarprofil:", err);
    }
  }

  // Hamburger toggle
  document.addEventListener("DOMContentLoaded", function () {
    const menuBtn = document.getElementById("menuToggle");
    const sidebar = document.querySelector(".sidebar");

    menuBtn.addEventListener("click", () => {
      const isActive = sidebar.classList.toggle("active");
      document.body.classList.toggle("menu-open", isActive);
    });

    window.addEventListener("click", (e) => {
      const isClickInsideMenu = sidebar.contains(e.target);
      const isClickOnToggle = menuBtn.contains(e.target);
      const isMobile = window.innerWidth <= 768;

      if (!isClickInsideMenu && !isClickOnToggle && isMobile) {
        sidebar.classList.remove("active");
        document.body.classList.remove("menu-open");
      }
    });
  });

  // Buttons
  document.getElementById('filterBtn').addEventListener('click', applyFilters);
  document.getElementById('sortBtn').addEventListener('click', sortByDate);
  document.getElementById('reloadBtn').addEventListener('click', reloadPayments);
  document.getElementById('pdfBtn').addEventListener('click', exportReceiptAsPDF);
  document.getElementById('refundBtn').addEventListener('click', () => {
    if (!currentReceipt) return;
    // order = sessionId i normalizeForReceipt
    const sessionId = String(currentReceipt.order || '').replace(/^#/, '');
    requestRefund(sessionId, currentReceipt.amount_total || 0);
  });

  // Init
  loadUserProfile();
  reloadPayments();
</script>
<script src="/js/logout.js"></script>
</body>
</html>

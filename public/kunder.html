<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kunder ‚Äì Kundportal</title>
  <link rel="stylesheet" href="CSS/kunder.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" defer></script>
</head>
<body>
  <!-- Hamburgermeny f√∂r mobil -->
<button class="hamburger-menu" onclick="toggleSidebar()">‚ò∞</button>
  <!-- SIDOMENY -->
  <div class="sidebar">
  <div class="logo">
    <a href="customerportal.html">
      <img src="images/logo.png" alt="Logotyp" class="logo-img" />
    </a>
  </div>
  <ul class="nav-menu">
  <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
  <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
  <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
  <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
  <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
  <li class="active"><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
  <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
  <li><a href="marknadsforing.html"><i class="fas fa-bullhorn"></i> Marknadsf√∂ring</a></li>
  <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
  <li><a href="installningar.html"><i class="fas fa-cog"></i> Inst√§llningar</a></li>
</ul>
<div class="help">
  <a href="faq.html"><i class="fas fa-question-circle"></i> Hj√§lp</a>
</div>
  </div>


  <!-- HUVUDINNEH√ÖLL -->
  <main class="main">
    <div class="profile-wrapper">
  <div class="profile-icon" id="profileToggle">--</div>

  <div class="profile-dropdown" id="profileMenu">
    <div class="profile-email" id="userEmail">Laddar...</div>
    <hr />
    <a href="#" id="switchAccount">Byt konto</a>
    <a href="#" id="openSettings">Profilinst√§llningar</a>
    <a href="#" id="logout">Logga ut</a>
  </div>
</div>
    <h1 class="header">Kundmeddelanden</h1>
    <p class="subtitle">H√§r ser du alla inkommande kund√§renden.</p>

    <!-- S√∂k och meddelandeknapp -->
    <div class="table-header" style="display: flex; gap: 10px; align-items: center;">
      <input id="searchInput" type="text" placeholder="üîç S√∂k kundmeddelande..." />
      <button class="message-btn" onclick="openMessageModal()"> Skriv meddelande</button>
    </div>

    <!-- TABELL -->
    <table class="customer-table">
  <thead>
    <tr>
      <th>Kund</th>
      <th>√Ñmne</th>
      <th>Senaste meddelande</th>
      <th>Datum</th>
    </tr>
  </thead>
  <tbody>
    <!-- JS fyller detta -->
  </tbody>
</table>



  <!-- MODAL: Skicka meddelande -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeMessageModal()">&times;</span>
      <h2>Skicka meddelande till kund</h2>
      <form onsubmit="sendMessage(event)">
        <label for="customer">Kund:</label>
        <input type="text" id="customer" required placeholder="Ex. Anna Karlsson" />

        <label for="subject">√Ñmne:</label>
        <input type="text" id="subject" required placeholder="√Ñmne..." />

        <label for="message">Meddelande:</label>
        <textarea id="message" required placeholder="Skriv ditt meddelande h√§r..."></textarea>

        <button type="submit" class="send-btn">Skicka</button>
      </form>
    </div>
  </div>
</main>

  <!-- JS -->
<script>
/**
 * üîß KONFIG (g√∂r portalen generell f√∂r alla kunder)
 * - API_BASE: l√§mna '' f√∂r samma dom√§n/proxy, eller peka mot din gateway.
 * - TENANT: l√§ses automatiskt fr√•n subdom√§n (acme.source-database.com ‚Üí acme)
 *           men kan ocks√• s√§ttas via localStorage('tenant') eller hardcodas h√§r.
 */
const CONFIG = (() => {
  const API_BASE = ''; // t.ex. '' (samma origin) eller 'https://source-database.onrender.com'
  const sub = location.hostname.split('.')[0];
  const tenantFromSub = (sub && sub !== 'www' && /^[a-z0-9-]+$/i.test(sub)) ? sub : null;
  const tenantFromLS  = localStorage.getItem('tenant') || null;
  const TENANT = tenantFromLS || tenantFromSub || null;

  return { API_BASE, TENANT, DEFAULT_LIMIT: 50 };
})();

/** Hj√§lpmetoder */
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

const state = {
  page: 1,
  limit: CONFIG.DEFAULT_LIMIT,
  sort: 'desc', // skapad/nyast f√∂rst
  q: '',
  loading: false
};

const els = {
  tbody: document.querySelector('.customer-table tbody'),
  search: document.getElementById('searchInput'),
  modal: document.getElementById('messageModal'),
  profileToggle: document.getElementById('profileToggle'),
  profileMenu: document.getElementById('profileMenu'),
  userEmail: document.getElementById('userEmail'),
};

/** Liten debounce f√∂r s√∂k */
function debounce(fn, ms = 300) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}

/** Bygg URL till API (respekterar proxy/same-origin) */
function apiUrl(path, params = {}) {
  const base = CONFIG.API_BASE || '';
  const url = new URL((base.endsWith('/') ? base.slice(0, -1) : base) + path, location.origin);
  Object.entries(params).forEach(([k, v]) => {
    if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
  });
  if (CONFIG.TENANT && !url.searchParams.has('tenant')) {
    url.searchParams.set('tenant', CONFIG.TENANT);
  }
  return url.toString();
}

/** S√§kert textinneh√•ll (du anv√§nder redan textContent ‚Äì bra) */
function td(text) {
  const c = document.createElement('td');
  c.textContent = text ?? '';
  return c;
}

/** Datumformat robust */
function fmtDate(value) {
  const d = new Date(value);
  return isNaN(d.getTime()) ? '' : d.toLocaleDateString();
}

/** Trunkera visning av senaste meddelande */
function truncate(text, max = 120) {
  if (!text) return '';
  return text.length > max ? text.slice(0, max - 1) + '‚Ä¶' : text;
}

/** Tomt- och laddtillst√•nd */
function renderLoading() {
  els.tbody.innerHTML = '';
  const tr = document.createElement('tr');
  const c = document.createElement('td');
  c.colSpan = 4;
  c.textContent = 'Laddar...';
  tr.appendChild(c);
  els.tbody.appendChild(tr);
}
function renderEmpty() {
  els.tbody.innerHTML = '';
  const tr = document.createElement('tr');
  const c = document.createElement('td');
  c.colSpan = 4;
  c.textContent = state.q ? 'Inga tr√§ffar p√• din s√∂kning.' : 'Inga kundmeddelanden √§nnu.';
  tr.appendChild(c);
  els.tbody.appendChild(tr);
}

/** H√§mta meddelanden (generiskt endpoint) */
async function fetchMessages({ page, limit, sort, q }) {
  // F√∂rs√∂k prim√§r /api/messages (med pagination/sort), fallback till /api/messages/latest
  const tryPrimary = apiUrl('/api/messages', { page, limit, sort, q });
  const tryFallback = apiUrl('/api/messages/latest');

  const headers = { 'Accept': 'application/json' };
  if (CONFIG.TENANT) headers['X-Tenant'] = CONFIG.TENANT;

    // Skicka session-cookie alltid (√§ven bakom proxy/subdom√§n): credentials:'include'
    const opts = { method: 'GET', headers, credentials: 'include', cache: 'no-store' };


  let res = await fetch(tryPrimary, opts);
  if (!res.ok) {
    // prova fallback
    res = await fetch(tryFallback, opts);
  }
  if (!res.ok) {
    const text = await res.text().catch(()=>'');
    throw new Error(`API-fel ${res.status}: ${text}`);
  }
  const data = await res.json();
  // St√∂d b√•de {items:[...]} och ren array
  return Array.isArray(data) ? data : (data.items ?? []);
}

/** Rendera tabellrader (med debug-loggar) */
function renderRows(rows) {
  console.log('üîé renderRows fick:', rows);
  els.tbody.innerHTML = '';
  if (!Array.isArray(rows)) {
    console.warn('rows √§r inte en array ‚Üí', rows);
    renderEmpty();
    return;
  }
  rows.forEach((entry, idx) => {
    console.log('‚û°Ô∏è Rad', idx, entry);
    const tr = document.createElement('tr');
    tr.addEventListener('click', () => {
      const params = new URLSearchParams({
        name: entry.customerName ?? '',
        subject: entry.subject ?? '',
        content: entry.message ?? '',
        date: fmtDate(entry.date)
      });
      location.href = `kundmeddelande.html?${params.toString()}`;
    });

    const name = entry.customerName ?? entry.name ?? '';
    const subj = entry.subject ?? entry.topic ?? '';
    const msg  = truncate(entry.message ?? entry.lastMessage ?? entry.content ?? '');
    const date = fmtDate(entry.date ?? entry.createdAt ?? entry.updatedAt);

    tr.append(td(name), td(subj), td(msg), td(date));
    els.tbody.appendChild(tr);
  });
}

/** Ladda lista */
async function loadMessages() {
  if (state.loading) return;
  state.loading = true;
  renderLoading();
  try {
    const rows = await fetchMessages(state);
    if (!rows || rows.length === 0) {
      renderEmpty();
      return;
    }
    renderRows(rows);
  } catch (err) {
    console.error('Kunde inte ladda meddelanden:', err);
    els.tbody.innerHTML = '';
    const tr = document.createElement('tr');
    const c = document.createElement('td');
    c.colSpan = 4;
    c.textContent = 'Fel vid laddning av meddelanden. F√∂rs√∂k igen.';
    tr.appendChild(c);
    els.tbody.appendChild(tr);
  } finally {
    state.loading = false;
  }
}

/** S√∂khantering */
if (els.search) {
  els.search.addEventListener('input', debounce((e) => {
    state.q = e.target.value.trim();
    state.page = 1;
    loadMessages();
  }, 300));
}

/** Modal: √∂ppna/st√§ng */
function openMessageModal(){ els.modal.style.display = 'block'; }
function closeMessageModal(){ els.modal.style.display = 'none'; }
window.openMessageModal = openMessageModal;
window.closeMessageModal = closeMessageModal;

/** Skicka meddelande (generiskt) */
async function sendMessage(e) {
  e.preventDefault();
  const name = document.getElementById('customer').value.trim();
  const subject = document.getElementById('subject').value.trim();
  const message = document.getElementById('message').value.trim();
  if (!name || !subject || !message) {
    alert('Fyll i alla f√§lt.');
    return;
  }

  // H√§mta e-postadress fr√•n API om systemet har kundregister
  // Fallback: skicka med (name) och l√•t backend sl√• upp adress
  const body = {
    name,
    subject,
    message,
    // to: 'optional@address.com', // s√§tt om du redan vet mottagaren
    tenant: CONFIG.TENANT || undefined
  };

  try {
    const res = await fetch(apiUrl('/api/email/send'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      credentials: 'include',
      cache: 'no-store',
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok && (data.success !== false)) {
      alert(`‚úÖ Meddelandet har skickats!`);
      closeMessageModal();
      // uppdatera listan om backend loggar utg√•ende meddelanden som senaste
      loadMessages();
    } else {
      alert('‚ùå Kunde inte skicka meddelandet.');
    }
  } catch (err) {
    console.error('‚ùå Fel vid e-post:', err);
    alert('‚ùå N√•got gick fel vid skick.');
  }
}
window.sendMessage = sendMessage;

/** Profilmeny + profilinfo */
(function initProfile() {
  const toggle = els.profileToggle;
  const menu = els.profileMenu;
  toggle?.addEventListener('click', () => {
    const isOpen = menu.style.display === 'flex';
    menu.style.display = isOpen ? 'none' : 'flex';
    toggle.classList.toggle('open', !isOpen);
  });
  window.addEventListener('click', (e) => {
    if (!document.querySelector('.profile-wrapper').contains(e.target)) {
      menu.style.display = 'none';
      toggle.classList?.remove('open');
    }
  });

  document.getElementById('switchAccount')?.addEventListener('click', (e) => {
    e.preventDefault();
    if (confirm('Vill du logga ut och byta konto?')) location.href = 'login.html';
  });
  document.getElementById('openSettings')?.addEventListener('click', (e) => {
    e.preventDefault();
    location.href = 'profile.html';
  });

  // L√§s profil
  (async () => {
    try {
         const res = await fetch(apiUrl('/api/profile/me'), {
     headers: { 'Accept': 'application/json' },
        credentials: 'include',   // üü¢ se till att cookie f√∂ljer med
        cache: 'no-store'
      });
      const data = await res.json();
      if (data && (data.success !== false)) {
        // üü¢ Spara tenant i CONFIG (om backend skickar med)
        if (data.tenant) {
  CONFIG.TENANT = String(data.tenant).trim().toLowerCase();
}
        const name = data.name || '';
        const email = data.email || '';
        const image = data.profileImage;

        // Rendera ikon
        while (toggle.firstChild) toggle.removeChild(toggle.firstChild);
        if (image) {
          const img = document.createElement('img');
          img.src = image;
          img.alt = 'Profilbild';
          img.style.width = '32px';
          img.style.height = '32px';
          img.style.borderRadius = '50%';
          toggle.appendChild(img);
        } else {
          const initials = (name || '').split(' ').map(p => p.charAt(0).toUpperCase()).join('').substring(0,2) || '--';
          toggle.textContent = initials;
        }
        els.userEmail.textContent = email || 'Ej inloggad';
      } else {
        toggle.textContent = '??';
        els.userEmail.textContent = 'Ej inloggad';
      }
      // üü¢ Ladda meddelanden f√∂rst n√§r profil och tenant finns
      await loadMessages();
    } catch (err) {
      console.error('Fel vid h√§mtning av anv√§ndarprofil:', err);
      els.userEmail.textContent = 'Ej inloggad';
    }
  })();
})();

/** Init */
document.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.classList.add(`${savedTheme}-theme`);
  // Listan laddas nu efter profilh√§mtningen i initProfile()
});

</script>
<script>
  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const body = document.body;
    sidebar.classList.toggle('active');
    body.classList.toggle('menu-open');
  }
</script>

<script src="/js/logout.js"></script>

</body>
</html>
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kunder ‚Äì Kundportal</title>
  <link rel="stylesheet" href="CSS/kunder.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" defer></script>
</head>
<body>
  <!-- Hamburgermeny f√∂r mobil -->
<button class="hamburger-menu" onclick="toggleSidebar()">‚ò∞</button>
  <!-- SIDOMENY -->
  <div class="sidebar">
  <div class="logo">
    <a href="customerportal.html">
      <img src="images/logo.png" alt="Logotyp" class="logo-img" />
    </a>
  </div>
  <ul class="nav-menu">
  <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
  <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
  <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
  <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
  <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
  <li class="active"><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
  <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
  <li><a href="marknadsf√∂ring.html"><i class="fas fa-bullhorn"></i> Marknadsf√∂ring</a></li>
  <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
  <li><a href="installningar.html"><i class="fas fa-cog"></i> Inst√§llningar</a></li>
</ul>
<div class="help">
  <a href="faq.html"><i class="fas fa-question-circle"></i> Hj√§lp</a>
</div>
  </div>


  <!-- HUVUDINNEH√ÖLL -->
  <main class="main">
    <div class="profile-wrapper">
  <div class="profile-icon" id="profileToggle">--</div>

  <div class="profile-dropdown" id="profileMenu">
    <div class="profile-email" id="userEmail">Laddar...</div>
    <hr />
    <a href="#" id="switchAccount">Byt konto</a>
    <a href="#" id="openSettings">Profilinst√§llningar</a>
    <a href="#" id="logout">Logga ut</a>
  </div>
</div>
    <h1 class="header">Kundmeddelanden</h1>
    <p class="subtitle">H√§r ser du alla inkommande kund√§renden.</p>

    <!-- S√∂k och meddelandeknapp -->
    <div class="table-header" style="display: flex; gap: 10px; align-items: center;">
      <input type="text" placeholder="üîç S√∂k kundmeddelande..." />
      <button class="message-btn" onclick="openMessageModal()"> Skriv meddelande</button>
    </div>

    <!-- TABELL -->
    <table class="customer-table">
  <thead>
    <tr>
      <th>Kund</th>
      <th>√Ñmne</th>
      <th>Senaste meddelande</th>
      <th>Datum</th>
    </tr>
  </thead>
  <tbody>
    <!-- JS fyller detta -->
  </tbody>
</table>



  <!-- MODAL: Skicka meddelande -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeMessageModal()">&times;</span>
      <h2>Skicka meddelande till kund</h2>
      <form onsubmit="sendMessage(event)">
        <label for="customer">Kund:</label>
        <input type="text" id="customer" required placeholder="Ex. Anna Karlsson" />

        <label for="subject">√Ñmne:</label>
        <input type="text" id="subject" required placeholder="√Ñmne..." />

        <label for="message">Meddelande:</label>
        <textarea id="message" required placeholder="Skriv ditt meddelande h√§r..."></textarea>

        <button type="submit" class="send-btn">Skicka</button>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script>
    const savedTheme = localStorage.getItem("theme") || "light";
    document.body.classList.add(`${savedTheme}-theme`);

    function openMessageModal() {
      document.getElementById("messageModal").style.display = "block";
    }

    function closeMessageModal() {
      document.getElementById("messageModal").style.display = "none";
    }

    async function sendMessage(e) {
  e.preventDefault();
  const name = document.getElementById("customer").value;
  const subject = document.getElementById("subject").value;
  const message = document.getElementById("message").value;

  // Testdata: Karta med namn till e-post (byt ut mot riktiga data senare)
  const emailMap = {
    "Anna Karlsson": "anna@example.com",
    "Johan Eriksson": "johan@example.com",
    "Sara Nilsson": "sara@example.com"
    // L√§gg till fler testkunder h√§r
  };

  const to = emailMap[name];
  if (!to) {
    alert("‚ö†Ô∏è Kunde inte hitta e-postadress f√∂r kunden.");
    return;
  }

  try {
    const res = await fetch('/api/email/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to, subject, message })
    });

    const data = await res.json();
    if (data.success) {
      alert(`‚úÖ Meddelande till ${name} har skickats!`);
      closeMessageModal();
    } else {
      alert("‚ùå Det gick inte att skicka mejlet.");
    }
  } catch (err) {
    console.error('‚ùå Fel vid e-post:', err);
    alert("‚ùå N√•got gick fel vid mejlskick.");
  }
}

  </script>
    <script>
    function viewMessage(name, subject, content, date) {
      const params = new URLSearchParams({ name, subject, content, date });
      window.location.href = `kundmeddelande.html?${params.toString()}`;
    }

    window.onload = async () => {
      try {
        const res = await fetch('/api/messages/latest');
        const data = await res.json();

            const tbody = document.querySelector(".customer-table tbody");
    while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

    data.forEach(entry => {
      const tr = document.createElement("tr");
      tr.addEventListener("click", () => {
        viewMessage(
          entry.customerName,
          entry.subject,
          entry.message,
          new Date(entry.date).toLocaleDateString()
        );
      });

      const tdName = document.createElement("td");
      tdName.appendChild(document.createTextNode(entry.customerName ?? ""));

      const tdSubj = document.createElement("td");
      tdSubj.appendChild(document.createTextNode(entry.subject ?? ""));

      const tdMsg = document.createElement("td");
      tdMsg.appendChild(document.createTextNode(entry.message ?? ""));

      const tdDate = document.createElement("td");
      tdDate.appendChild(document.createTextNode(
        new Date(entry.date).toLocaleDateString()
      ));

      tr.append(tdName, tdSubj, tdMsg, tdDate);
      tbody.appendChild(tr);
    })
      } catch (err) {
        console.error("Kunde inte ladda meddelanden:", err);
      }
    };
  </script>
  <script>
  const toggle = document.getElementById('profileToggle');
  const menu = document.getElementById('profileMenu');

  toggle.addEventListener('click', () => {
    const isOpen = menu.style.display === 'flex';
    menu.style.display = isOpen ? 'none' : 'flex';
    toggle.classList.toggle('open', !isOpen);
  });

  window.addEventListener('click', function (e) {
    if (!document.querySelector('.profile-wrapper').contains(e.target)) {
      menu.style.display = 'none';
      toggle.classList.remove('open');
    }
  });

  document.getElementById("switchAccount").addEventListener("click", function (e) {
    e.preventDefault();
    if (confirm("Vill du logga ut och byta konto?")) {
      window.location.href = "login.html";
    }
  });

  document.getElementById("openSettings").addEventListener("click", function (e) {
    e.preventDefault();
    window.location.href = "profile.html";
  });

  async function loadUserProfile() {
    try {
      const res = await fetch("/api/profile/me");
      const data = await res.json();

      if (data.success) {
        const name = data.name || '';
        const email = data.email || '';
        const image = data.profileImage;

               const profileToggle = document.getElementById("profileToggle");
        while (profileToggle.firstChild) profileToggle.removeChild(profileToggle.firstChild);

        if (image) {
          const img = document.createElement("img");
          img.src = image;
          img.alt = "Profilbild";
          img.style.width = "32px";
          img.style.height = "32px";
          img.style.borderRadius = "50%";
          profileToggle.appendChild(img);
        } else {
          const initials = (name || "")
            .split(" ")
            .map(part => part.charAt(0).toUpperCase())
            .join("")
            .substring(0, 2);
          profileToggle.textContent = initials || "--";
        }

        document.getElementById("userEmail").textContent = email;
      } else {

        document.getElementById("profileToggle").textContent = "??";
        document.getElementById("userEmail").textContent = "Ej inloggad";
      }
    } catch (err) {
      console.error("Fel vid h√§mtning av anv√§ndarprofil:", err);
    }
  }

  loadUserProfile();
</script>
<script>
  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const body = document.body;

    sidebar.classList.toggle('active');
    body.classList.toggle('menu-open');
  }
</script>
<script src="/js/logout.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fakturor – Kundportal</title>

  <!-- TIDIG: sätt rätt tema innan CSS laddas (motverkar FOUC) -->
  <script>
    (function () {
      try {
        var t = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', t);
      } catch (e) {}
    })();
  </script>

  <!-- Globalt tema + layout -->
  <link rel="stylesheet" href="CSS/theme.css" />
  <!-- Sida-specifik CSS -->
  <link rel="stylesheet" href="CSS/fakturor.css" />

  <!-- Ikoner + typsnitt -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- CSRF-token (servern ska skriva in värdet här) -->
  <meta name="csrf-token" content="">

  <!-- Säkra fetch-hjälpare: API_BASE, CSRF, same-origin credentials -->
  <script>
    // Respektera ev. global API_BASE, annars tom sträng (samma origin)
    if (!('API_BASE' in window)) window.API_BASE = '';

    function getCsrfToken(){
      const meta = document.querySelector('meta[name="csrf-token"]');
      return meta ? meta.getAttribute('content') : null;
    }

    function toAbsolute(url){
      return /^https?:\/\//i.test(url) ? url : (window.API_BASE + url);
    }

    function isSameAuthOrigin(url){
      try{
        const u = new URL(url, location.origin);
        const a = new URL(window.API_BASE || '', location.origin);
        return u.origin === a.origin;
      }catch{ return true; }
    }

    async function authedFetch(url, opts = {}){
      const absoluteUrl = toAbsolute(url);
      const headers = new Headers(opts.headers || {});
      const csrf = getCsrfToken();
      if (csrf) headers.set('X-CSRF-Token', csrf);

      const finalOpts = {
        ...opts,
        headers,
        credentials: isSameAuthOrigin(absoluteUrl) ? 'include' : 'omit', // skicka cookies bara till vårt API
        mode: 'cors'
      };
      return fetch(absoluteUrl, finalOpts);
    }
  </script>
</head>

<body>
  <!-- Hamburger (mobil) -->
  <button id="menuToggle" class="hamburger-menu" aria-label="Visa meny">☰</button>

  <!-- ===== SIDOMENY ===== -->
  <aside class="sidebar" aria-label="Sidomeny">
    <div class="logo">
      <a href="customerportal.html">
        <img src="Images/logo.png" alt="Logotyp" class="logo-img" />
      </a>
    </div>

    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
      <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
      <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
      <li><a href="betalningslank.html"><i class="fas fa-link"></i> Betalningslänk</a></li>
      <li class="active"><a href="fakturor.html" aria-current="page"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
      <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
      <li><a href="marknadsforing.html"><i class="fas fa-bullhorn"></i> Marknadsföring</a></li>
      <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
      <li><a href="installningar.html"><i class="fas fa-cog"></i> Inställningar</a></li>
    </ul>

    <div class="help">
      <a href="faq.html">
        <i class="fas fa-circle-question"></i> Hjälp / FAQ
      </a>
    </div>
  </aside>

<!-- ===== HUVUDINNEHÅLL ===== -->
  <div class="main">
    <div class="profile-wrapper">
  <div class="profile-icon" id="profileToggle">--</div>

  <div class="profile-dropdown" id="profileMenu">
    <div class="profile-email" id="userEmail">Laddar...</div>
    <hr />
    <a href="#" id="switchAccount">Byt konto</a>
    <a href="#" id="openSettings">Profilinställningar</a>
    <a href="#" id="logout">Logga ut</a>
  </div>
</div>

<div class="header">Fakturor</div>
<p class="subtitle">Här visas dina fakturor från Source.</p>

<!-- Topp: piller + "Skapa faktura" -->
<div class="invoices-topbar">
  <div class="pill-group" role="tablist" aria-label="Fakturastatus">
    <button class="tab-pill active" data-filter="paid" role="tab" aria-selected="true">Betalda</button>
    <button class="tab-pill" data-filter="unpaid" role="tab" aria-selected="false">Obetalda</button>
    <button class="tab-pill" data-filter="overdue" role="tab" aria-selected="false">Förfallna</button>
  </div>
  <button id="createInvoiceBtn" class="btn-primary">Skapa faktura</button>
</div>

<!-- Två kolumner -->
<div class="invoices-layout">
  <!-- Vänster: tabell + förhandsvisning -->
  <section class="invoices-panel" aria-labelledby="invoices-table-title">
    <h2 id="invoices-table-title" class="visually-hidden">Fakturor</h2>

    <table class="invoice-table">
      <thead>
        <tr>
          <th>Faktura</th>
          <th>Datum</th>
          <th>Belopp</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="invoiceRows">
        <!-- Populeras via JS från API -->
      </tbody>
      <tbody id="invoiceEmpty" style="display:none;">
        <tr><td colspan="5" class="muted">Inga fakturor i denna kategori.</td></tr>
      </tbody>
    </table>

    <div class="card preview-card">
      <div class="card-header">
        <span>Förhandsvisning</span>
        <span class="muted">Förhandsvisning</span>
      </div>
      <div class="card-body">
        <div class="preview-row"><span class="muted">KUND</span><span class="muted">—</span></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </div>
      <div class="card-footer total-row">
        <span class="muted">Totalt</span>
        <strong>0 kr</strong>
      </div>
    </div>
  </section>

  <!-- Höger: skapa faktura (för kundens egna kunder, Stripe Connect senare) -->
  <aside class="create-panel" aria-labelledby="create-invoice-title">
    <h2 id="create-invoice-title">Skapa faktura</h2>

    <form id="createInvoiceForm" novalidate>
      <label for="ci-customer">Kund</label>
      <input id="ci-customer" name="customer" type="text" placeholder="Företag / person" required />

      <label for="ci-email">E-post</label>
      <input id="ci-email" name="email" type="email" placeholder="kund@exempel.se" required />

      <div class="items-grid">
        <div class="items-header">
          <span>Beskrivning</span>
          <span>Belopp</span>
        </div>
        <div id="ci-items" class="items-body">
          <div class="item-row">
            <input name="item[0].desc" type="text" placeholder="Tjänst/vara" />
            <input name="item[0].amount" type="number" step="0.01" min="0" placeholder="0,00" inputmode="decimal" />
          </div>
        </div>
        <button type="button" id="addItem" class="btn-ghost">+ Lägg till rad</button>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary">Skicka faktura</button>
      </div>
    </form>
  </aside>
</div>

<script>
  // === API-endpoints (byt på ett ställe vid behov) ===
  const ENDPOINTS = {
    listInvoices: (status) => `/api/invoices?status=${encodeURIComponent(status)}`,          // Source → kundens fakturor till Source
    downloadInvoice: (id)   => `/api/invoices/${encodeURIComponent(id)}/pdf`,               // PDF-nedladdning
    createCustomerInvoice: () => `/api/customer-invoices`                                   // Kund → deras egna kunder (Stripe Connect)
  };

  // Formatterare (svenska)
  const fmtCurrency = (amountMinor, currency = 'SEK') => {
    // amountMinor i ören (minor units). Om API redan returnerar i kronor, konvertera inte.
    const val = (typeof amountMinor === 'number') ? (amountMinor / 100) : Number(amountMinor || 0);
    return new Intl.NumberFormat('sv-SE', { style: 'currency', currency }).format(val);
  };
  const fmtDate = (iso) => {
    try { return new Date(iso).toLocaleDateString('sv-SE', { year:'numeric', month:'short', day:'numeric' }); }
    catch { return iso || ''; }
  };

  function badgeHTML(status){
    const s = (status || '').toLowerCase();
    if (s === 'paid' || s === 'betald')         return '<span class="badge badge-paid">Betald</span>';
    if (s === 'overdue' || s === 'förfallen')   return '<span class="badge badge-overdue">Förfallen</span>';
    return '<span class="badge badge-unpaid">Obetald</span>';
  }

  function mapRow(rec){
    // Flexibel mappning: stöd olika fältnamn utan att låsa format
    const id   = rec.id || rec.invoiceId || rec._id || rec.number || rec.invoice_number;
    const num  = rec.number || rec.invoice_number || `#${id ?? ''}`.replace(/^([^#])/, '#$1');
    const date = rec.date || rec.created_at || rec.createdAt || rec.issued_at || rec.issuedAt;
    const amt  = rec.amount_total || rec.total || rec.amount || rec.amount_due || rec.amountDue;
    const cur  = rec.currency || 'SEK';
    const st   = rec.status || rec.state;

    return {
      id, num: num || (id ? `#${id}` : ''), date: fmtDate(date), amount: fmtCurrency(amt, cur), status: st
    };
  }

  async function loadInvoices(status){
    const tbody = document.getElementById('invoiceRows');
    const empty = document.getElementById('invoiceEmpty');
    tbody.innerHTML = ''; empty.style.display = 'none';

    try{
      const res = await authedFetch(ENDPOINTS.listInvoices(status), { method: 'GET' });
      if (!res.ok) throw new Error('Kunde inte hämta fakturor');
      const payload = await res.json();
      const items = Array.isArray(payload?.data) ? payload.data : (Array.isArray(payload) ? payload : []);
      if (!items.length){
        empty.style.display = '';
        return;
      }
      const rowsHtml = items.map(mapRow).map(r => `
        <tr data-status="${(r.status || '').toLowerCase()}">
          <td>${r.num || ''}</td>
          <td>${r.date || ''}</td>
          <td>${r.amount || ''}</td>
          <td>${badgeHTML(r.status)}</td>
          <td>
            ${r.id ? `<button class="icon-btn download-btn" data-id="${String(r.id).replace(/"/g,'&quot;')}" title="Ladda ner" aria-label="Ladda ner ${r.num || 'faktura'}"><i class="fas fa-download"></i></button>` : ''}
          </td>
        </tr>
      `).join('');
      tbody.innerHTML = rowsHtml;

      // bind nedladdning
      tbody.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!id) return;
          // Låt servern svara med Content-Disposition: attachment
          location.href = toAbsolute(ENDPOINTS.downloadInvoice(id));
        });
      });
    }catch(err){
      console.error(err);
      empty.style.display = '';
    }
  }

  (function initInvoicesUI(){
    const pills = document.querySelectorAll('.tab-pill');

    function setActive(btn){
      pills.forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
    }

    pills.forEach(p => {
      p.addEventListener('click', (e) => {
        const filter = e.currentTarget.dataset.filter;
        setActive(e.currentTarget);
        loadInvoices(filter);
      });
    });

    // Förvald vy: Betalda (matchar mockup)
    loadInvoices('paid');

    // Skapa rad i formuläret
    document.getElementById('addItem')?.addEventListener('click', () => {
      const idx = document.querySelectorAll('#ci-items .item-row').length;
      const row = document.createElement('div');
      row.className = 'item-row';
      row.innerHTML = `
        <input name="item[${idx}].desc" type="text" placeholder="Tjänst/vara" />
        <input name="item[${idx}].amount" type="number" step="0.01" min="0" placeholder="0,00" inputmode="decimal" />
      `;
      document.getElementById('ci-items').appendChild(row);
    });

    // Scroll till formuläret
    document.getElementById('createInvoiceBtn')?.addEventListener('click', () => {
      document.getElementById('create-invoice-title')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Submit: förberedd för Stripe Connect i backend
    document.getElementById('createInvoiceForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fd = new FormData(e.currentTarget);
      const customer = (fd.get('customer') || '').toString().trim();
      const email    = (fd.get('email') || '').toString().trim();

      const items = Array.from(document.querySelectorAll('#ci-items .item-row')).map((row, i) => {
        const desc   = row.querySelector(`input[name="item[${i}].desc"]`)?.value?.toString() || '';
        const amount = row.querySelector(`input[name="item[${i}].amount"]`)?.value || '0';
        return { description: desc, amount_minor: Math.round(parseFloat(amount.replace(',', '.')) * 100) || 0, currency: 'SEK' };
      }).filter(x => x.description || x.amount_minor > 0);

      // Minimal validering klient-side
      if (!customer || !email || !items.length){
        alert('Fyll i kund, e-post och minst en rad.');
        return;
      }

      try{
        const res = await authedFetch(ENDPOINTS.createCustomerInvoice(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customer_name: customer, customer_email: email, items })
        });
        if (!res.ok) throw new Error('Kunde inte skapa faktura');
        const data = await res.json();

        // Förväntat backend-beteende (exempel): returnera invoiceId/hostedUrl
        if (data?.hosted_invoice_url){
          // Öppna Stripe Hosted Invoice Page om backend redan skapat en utkast-faktura via Connect
          window.open(data.hosted_invoice_url, '_blank', 'noopener');
        }else{
          alert('Fakturan har skapats. (Backend kan konfigurera Hosted Invoice Page/utskick.)');
        }
        e.currentTarget.reset();
        document.getElementById('ci-items').innerHTML = `
          <div class="item-row">
            <input name="item[0].desc" type="text" placeholder="Tjänst/vara" />
            <input name="item[0].amount" type="number" step="0.01" min="0" placeholder="0,00" inputmode="decimal" />
          </div>
        `;
      }catch(err){
        console.error(err);
        alert('Ett fel uppstod vid skapande av faktura.');
      }
    });
  })();

  // Tema (oförändrat)
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.classList.add(`${savedTheme}-theme`);
</script>

  <script>
  const toggle = document.getElementById('profileToggle');
  const menu = document.getElementById('profileMenu');

  toggle.addEventListener('click', () => {
    const isOpen = menu.style.display === 'flex';
    menu.style.display = isOpen ? 'none' : 'flex';
    toggle.classList.toggle('open', !isOpen);
  });

  window.addEventListener('click', function (e) {
    if (!document.querySelector('.profile-wrapper').contains(e.target)) {
      menu.style.display = 'none';
      toggle.classList.remove('open');
    }
  });

  document.getElementById("switchAccount").addEventListener("click", function (e) {
    e.preventDefault();
    if (confirm("Vill du logga ut och byta konto?")) {
      window.location.href = "login.html";
    }
  });

  document.getElementById("openSettings").addEventListener("click", function (e) {
    e.preventDefault();
    window.location.href = "profile.html";
  });

  async function loadUserProfile() {
    try {
      const res = await fetch("/api/profile/me");
      const data = await res.json();

      if (data.success) {
        const name = data.name || '';
        const email = data.email || '';
        const image = data.profileImage;

        const container = document.getElementById("profileToggle");
        // Rensa säkert
        while (container.firstChild) container.removeChild(container.firstChild);

        if (image) {
          const img = document.createElement("img");
          img.src = image; // säkert – ingen HTML tolkas
          img.alt = "Profilbild";
          img.style.width = "32px";
          img.style.height = "32px";
          img.style.borderRadius = "50%";
          container.appendChild(img);
        } else {
          const initials = (name || "")
            .split(" ")
            .map(part => part.charAt(0).toUpperCase())
            .join("")
            .substring(0, 2);
          container.textContent = initials || "--";
        }

        document.getElementById("userEmail").textContent = email;
      } else {
        document.getElementById("profileToggle").textContent = "??";
        document.getElementById("userEmail").textContent = "Ej inloggad";
      }
    } catch (err) {
      console.error("Fel vid hämtning av användarprofil:", err);
    }
  }

  loadUserProfile();
</script>
<script>
  // Hantera hamburgermeny-klick
  function toggleSidebar() {
    document.querySelector(".sidebar").classList.toggle("active");
    document.body.classList.toggle("menu-open");
  }
</script>
<script>
  // Om Theme finns, initiera och bind radios
  if (window.Theme) {
    Theme.init();
    Theme.wireRadios(document);
  } else {
    console.warn("Theme.js hittades inte (fel sökväg?).");
  }
</script>
<script src="/js/logout.js"></script>
</body>
</html>

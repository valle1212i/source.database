<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inst√§llningar ‚Äì Kundportal</title>

  <!-- Sida-specifik CSS (inneh√•ller √§ven gemensam meny-CSS √∂verst) -->
  <link rel="stylesheet" href="CSS/installningar.css" />

  <!-- Ikoner -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Inter (matchar dina andra sidor) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- SIDOMENY -->
  <button id="menuToggle" class="hamburger-menu" aria-label="Visa meny">‚ò∞</button>
  <div class="sidebar">
    <div class="logo">
      <a href="customerportal.html">
        <img src="images/logo.png" alt="Logotyp" class="logo-img" />
      </a>
    </div>

    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
      <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
      <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
      <li><a href="betalningslank.html"><i class="fas fa-link"></i> Betalningsl√§nk</a></li>
      <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
      <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
      <li><a href="marknadsforing.html"><i class="fas fa-bullhorn"></i> Marknadsf√∂ring</a></li>
      <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
      <li class="active"><a href="installningar.html"><i class="fas fa-cog"></i> Inst√§llningar</a></li>
    </ul>

    <div class="help">
      <a href="faq.html">
        <i class="fas fa-circle-question"></i> Hj√§lp / FAQ
      </a>
    </div>
  </div>

  <!-- HUVUDINNEH√ÖLL -->
  <main class="main">
    <!-- Profilmeny uppe till h√∂ger -->
    <div class="profile-wrapper">
      <button class="profile-icon" id="profileToggle" title="Profil">--</button>
      <div class="profile-dropdown" id="profileMenu">
        <div class="profile-email" id="userEmail">Laddar...</div>
        <hr />
        <a href="#" id="switchAccount"><i class="fa-solid fa-right-from-bracket"></i> Byt konto</a>
        <a href="#" id="openSettings"><i class="fa-solid fa-user-gear"></i> Profilinst√§llningar</a>
        <a href="#" id="logout"><i class="fa-solid fa-arrow-right-to-bracket"></i> Logga ut</a>
      </div>
    </div>

    <h1 class="page-title"><i class="fas fa-sliders"></i> Inst√§llningar</h1>
    <p class="subtitle">Justera spr√•k, tema, anv√§ndare & andra portalinst√§llningar.</p>

    <div class="settings-grid">
      <!-- V√ÑNSTER KOL -->
      <section class="card">
        <h2>üåê Spr√•k</h2>
        <label for="language" class="label">V√§lj spr√•k</label>
        <select id="language" class="input">
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
        <p class="note">Spr√•ket p√•verkar texter i portalen n√§sta g√•ng sidan laddas.</p>
      </section>

      <section class="card">
        <h2>üé® Tema</h2>
        <div class="theme-row">
          <label class="theme-option">
            <input type="radio" name="theme" value="light" checked />
            <span class="swatch swatch-light"></span> Ljust
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="dark" />
            <span class="swatch swatch-dark"></span> M√∂rkt
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="green" />
            <span class="swatch swatch-green"></span> Skogsgr√∂n
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="indigo" />
            <span class="swatch swatch-indigo"></span> Indigo
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="contrast" />
            <span class="swatch swatch-contrast"></span> H√∂g kontrast
          </label>
        </div>
        <p class="note">Temat byts direkt och sparas som standard p√• denna enhet.</p>
      </section>

      <!-- H√ñGER KOL -->
      <section class="card">
        <div class="card-header">
          <h2>üë• Anv√§ndare & Roller</h2>
          <button class="btn brand" id="openInviteModal"><i class="fa-solid fa-user-plus"></i> Bjud in</button>
        </div>
        <div class="user-list" id="userList">
          <p>Laddar anv√§ndare...</p>
        </div>
      </section>

      <section class="card" id="admin-login-link" style="display:none;">
        <h2>üïµÔ∏è‚Äç‚ôÇÔ∏è Admin: Inloggningshistorik</h2>
        <p>Visa senaste IP-adresser och enheter.</p>
        <a class="btn" href="admin-logins.html"><i class="fa-solid fa-arrow-up-right-from-square"></i> √ñppna loggar</a>
      </section>

      <section class="card">
        <h2>üì© Kontakta support</h2>
        <p>Beh√∂ver du hj√§lp? <a class="inline-link" href="kontakt.html">Kontakta oss h√§r</a>.</p>
      </section>

      <section class="card">
        <h2>üìç Senaste inloggningar</h2>
        <div class="login-history">
          <div class="login-row">
            <div><strong>Datum:</strong> 2025-07-22 13:05</div>
            <div><strong>IP:</strong> 192.168.1.15</div>
            <div><strong>Enhet:</strong> Chrome / Windows</div>
          </div>
          <div class="login-row">
            <div><strong>Datum:</strong> 2025-07-20 08:45</div>
            <div><strong>IP:</strong> 192.168.1.18</div>
            <div><strong>Enhet:</strong> Safari / iPhone</div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>üõ† Kommande inst√§llningar</h2>
        <ul class="list">
          <li>API-nycklar f√∂r integrationer</li>
          <li>Webhook-h√§ndelser</li>
          <li>Branding (eget namn, f√§rg)</li>
        </ul>
      </section>
    </div>

    <!-- √ÖTG√ÑRDER -->
    <div class="settings-actions">
      <button class="btn ok save-btn"><i class="fa-solid fa-floppy-disk"></i> Spara inst√§llningar</button>
      <button class="btn ghost undo-btn"><i class="fa-solid fa-rotate-left"></i> √Öngra √§ndringar</button>
    </div>
  </main>

  <!-- Toast-container -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- INVITE MODAL -->
  <div class="modal-overlay" id="inviteModalOverlay">
    <div class="modal" id="inviteModal">
      <button class="close-modal" id="closeInviteModal" aria-label="St√§ng">&times;</button>
      <h3><i class="fa-solid fa-user-plus"></i> Bjud in anv√§ndare</h3>
      <form id="inviteUserForm">
        <label for="inviteName" class="label">Namn</label>
        <input type="text" id="inviteName" class="input" required placeholder="F√∂rnamn Efternamn" />

        <label for="inviteEmail" class="label">E-postadress</label>
        <input type="email" id="inviteEmail" class="input" required placeholder="anvandare@exempel.se" />

        <button type="submit" class="btn brand full"><i class="fa-solid fa-paper-plane"></i> Skicka inbjudan</button>
      </form>
    </div>
  </div>

  <!-- ===== SCRIPTS ===== -->
  <script>
    // Hamburger
    const menuBtn = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    menuBtn.addEventListener('click', () => {
      const active = sidebar.classList.toggle('active');
      document.body.classList.toggle('menu-open', active);
    });
    // St√§ng vid klick utanf√∂r (mobil)
    window.addEventListener('click', (e) => {
      if (window.innerWidth <= 768) {
        if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
          sidebar.classList.remove('active');
          document.body.classList.remove('menu-open');
        }
      }
    });

    // Toast
    function showToast(message) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3200);
    }

    // Profilmeny
    const toggle = document.getElementById('profileToggle');
    const menu = document.getElementById('profileMenu');
    toggle.addEventListener('click', () => {
      const open = menu.style.display === 'flex';
      menu.style.display = open ? 'none' : 'flex';
      toggle.classList.toggle('open', !open);
    });
    window.addEventListener('click', (e) => {
      if (!document.querySelector('.profile-wrapper').contains(e.target)) {
        menu.style.display = 'none';
        toggle.classList.remove('open');
      }
    });

    document.getElementById("switchAccount").addEventListener("click", (e) => {
      e.preventDefault();
      if (confirm("Vill du logga ut och byta konto?")) window.location.href = "login.html";
    });
    document.getElementById("openSettings").addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "profile.html";
    });

    async function loadUserProfile() {
      try {
        const res = await fetch("/api/profile/me", { credentials: "include" });
        const data = await res.json();
        const emailEl = document.getElementById("userEmail");

        if (data.success) {
          const name = data.name || "";
          const email = data.email || "";
          const image = data.profileImage;
          const profileToggle = document.getElementById("profileToggle");
          profileToggle.textContent = "";

          if (image) {
            const img = document.createElement("img");
            img.src = image;
            img.alt = "Profilbild";
            img.width = 32; img.height = 32;
            profileToggle.appendChild(img);
          } else {
            const initials = (name || "")
              .split(" ").map(p => p.charAt(0).toUpperCase()).join("").slice(0,2);
            profileToggle.textContent = initials || "--";
          }
          emailEl.textContent = email;

          // Visa adminl√§nk om API skickar role: "admin" (om ej, l√§mna dold)
          if (data.role === "admin") {
            const adminBox = document.getElementById("admin-login-link");
            if (adminBox) adminBox.style.display = "block";
          }
        } else {
          document.getElementById("profileToggle").textContent = "??";
          emailEl.textContent = "Ej inloggad";
        }
      } catch (err) {
        console.error("Fel vid h√§mtning av profil:", err);
      }
    }
    loadUserProfile();

    // Tema & spr√•k
    let initialTheme, initialLanguage;
    const savedTheme = localStorage.getItem("theme") || "light";
    document.body.classList.add(`theme-${savedTheme}`);
    document.querySelector(`input[name="theme"][value="${savedTheme}"]`).checked = true;

    initialLanguage = document.getElementById("language").value;
    initialTheme = savedTheme;

    document.querySelectorAll('input[name="theme"]').forEach(r => {
      r.addEventListener('change', () => {
        document.body.classList.remove("theme-light","theme-dark","theme-green","theme-indigo","theme-contrast");
        document.body.classList.add(`theme-${r.value}`);
      });
    });

    document.querySelector('.save-btn').addEventListener('click', () => {
      const selectedTheme = document.querySelector('input[name="theme"]:checked').value;
      const selectedLanguage = document.getElementById('language').value;

      localStorage.setItem("theme", selectedTheme);
      document.body.classList.remove("theme-light","theme-dark","theme-green","theme-indigo","theme-contrast");
      document.body.classList.add(`theme-${selectedTheme}`);
      // (Om du vill spara spr√•k i backend ‚Äì posta h√§r)

      showToast("‚úÖ Inst√§llningar sparade.");
    });

    document.querySelector('.undo-btn').addEventListener('click', () => {
      document.getElementById("language").value = initialLanguage;
      document.body.classList.remove("theme-light","theme-dark","theme-green","theme-indigo","theme-contrast");
      document.body.classList.add(`theme-${initialTheme}`);
      document.querySelector(`input[name="theme"][value="${initialTheme}"]`).checked = true;
      showToast("‚Ü©Ô∏è √Ñndringar √•ngrade.");
    });

    // Ladda anv√§ndare
    async function loadUserList() {
      const container = document.getElementById("userList");
      container.innerHTML = "<p>Laddar anv√§ndare...</p>";
      try {
        const res = await fetch("/api/invites/users", { credentials: "include" });
        const data = await res.json();
        if (!data.success || !Array.isArray(data.users)) {
          container.innerHTML = "<p>Kunde inte h√§mta anv√§ndarlista.</p>";
          return;
        }
        if (data.users.length === 0) {
          container.innerHTML = "<p>Inga anv√§ndare hittades.</p>";
          return;
        }
        const ul = document.createElement("ul");
        ul.className = "user-ul";
        data.users.forEach(u => {
          const li = document.createElement("li");
          li.className = "user-li";
          li.innerHTML = `<span class="dot"></span><span>${u.name} (${u.email})</span><span class="role">${u.role === "admin" ? "Admin" : "Anv√§ndare"}</span>`;
          ul.appendChild(li);
        });
        container.innerHTML = "";
        container.appendChild(ul);
      } catch (err) {
        console.error("Fel vid h√§mtning av anv√§ndare:", err);
        container.innerHTML = "<p>Ett fel uppstod.</p>";
      }
    }
    document.addEventListener("DOMContentLoaded", loadUserList);

    // Admin: ladda historik (om du har ett skyddat API)
    async function loadLoginHistory() {
      const box = document.querySelector('.login-history');
      if (!box) return;
      try {
        const res = await fetch("/api/security/logins", { credentials: "include" });
        const data = await res.json();
        if (!data?.success || !Array.isArray(data.logins)) return;
        box.innerHTML = "";
        data.logins.forEach(l => {
          const row = document.createElement("div");
          row.className = "login-row";
          const ts = String(l.timestamp || "");
          const ip = String(l.ip || "");
          const dev = String(l.device || "Ok√§nd");
          row.innerHTML = `<div><strong>Datum:</strong> ${ts}</div><div><strong>IP:</strong> ${ip}</div><div><strong>Enhet:</strong> ${dev}</div>`;
          box.appendChild(row);
        });
      } catch {}
    }
    loadLoginHistory();

    // Modal: inbjudan
    const openBtn = document.getElementById("openInviteModal");
    const modalOverlay = document.getElementById("inviteModalOverlay");
    const closeBtn = document.getElementById("closeInviteModal");

    openBtn.addEventListener("click", () => { modalOverlay.style.display = "flex"; });
    closeBtn.addEventListener("click", () => { modalOverlay.style.display = "none"; });
    window.addEventListener("click", (e) => { if (e.target === modalOverlay) modalOverlay.style.display = "none"; });

    document.getElementById("inviteUserForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("inviteName").value.trim();
      const email = document.getElementById("inviteEmail").value.trim();
      if (!name || !email) return showToast("‚ö†Ô∏è Fyll i namn och e-post.");

      try {
        const res = await fetch("/api/invites/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email }),
          credentials: "include"
        });
        const data = await res.json();
        if (data.success) {
          showToast("‚úÖ Inbjudan skickad!");
          e.target.reset();
          modalOverlay.style.display = "none";
          loadUserList();
        } else showToast("‚ùå " + (data.message || "Fel vid inbjudan."));
      } catch (err) {
        console.error(err);
        showToast("‚ùå N√•got gick fel.");
      }
    });
  </script>

  <!-- (valfritt) logout.js om du anv√§nder den globalt -->
  <script src="/js/logout.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TikTok Ads ‚Äì Stegvis</title>
  <link rel="stylesheet" href="CSS/tiktokads.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="Images/logo.png" alt="Logotyp" class="logo-img" />
    </div>
    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="googleads.html"><i class="fab fa-google"></i> Google Ads</a></li>
      <li><a href="metaads.html"><i class="fab fa-facebook"></i> Meta Ads</a></li>
      <li class="active"><a href="tiktokads.html"><i class="fab fa-tiktok"></i> TikTok Ads</a></li>
      <li><a href="linkedin.html"><i class="fab fa-linkedin"></i> Linkedin Ads</a></li>
      <li><a href="aimarknadsstudio.html"><i class="fas fa-magic"></i> AI Studio</a></li>
      <li><a href="radgivning.html"><i class="fas fa-headset"></i> R√•dgivning</a></li>
    </ul>
    <div class="help">
      <a href="faq.html" style="color:#9ca3af; text-decoration:none;">
        <i class="fas fa-circle-question"></i> Hj√§lp / FAQ
      </a>
    </div>
  </div>

  <div class="main-content">
    <a href="marknadsforing.html" class="back-link">&larr; Tillbaka</a>

    <form id="stepForm">
      <div class="progress-text" id="progressText">Steg 1 av 4</div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- Steg 1 -->
      <div class="form-step active">
        <h2>Vad √§r m√•let med kampanjen?</h2>
        <div class="options">
          <label><input type="radio" name="objective" value="awareness" required /> Varum√§rkesmedvetenhet</label>
          <label><input type="radio" name="objective" value="traffic" /> Webbplatstrafik</label>
          <label><input type="radio" name="objective" value="conversions" /> Konverteringar</label>
          <label><input type="radio" name="objective" value="followers" /> Fler f√∂ljare</label>
        </div>
        <div class="form-buttons">
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- Steg 2 -->
      <div class="form-step">
        <h2>Beskriv din m√•lgrupp</h2>
        <textarea name="target" rows="3" placeholder="√Ölder, intressen, plats" required></textarea>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- Steg 3 -->
      <div class="form-step">
        <h2>Vad vill du kommunicera?</h2>
        <textarea name="message" rows="3" placeholder="Skriv ditt budskap" required></textarea>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- Steg 4 -->
      <div class="form-step">
        <h2>Vilken stil vill du ha?</h2>
        <select name="style">
          <option value="">V√§lj stil</option>
          <option value="trendig">Trendig & ungdomlig</option>
          <option value="professionell">Professionell & tydlig</option>
          <option value="humor">Humoristisk</option>
          <option value="storytelling">Ber√§ttande/storytelling</option>
        </select>

        <label for="hashtag">F√∂reslagna hashtags (valfritt):</label>
        <input type="text" name="hashtag" placeholder="#dinhashtag"/>

        <label for="cta">Call-to-action:</label>
        <select name="cta">
          <option value="">V√§lj CTA</option>
          <option value="shop">K√∂p nu</option>
          <option value="read">L√§s mer</option>
          <option value="signup">Registrera dig</option>
          <option value="visit">Bes√∂k webbplats</option>
        </select>

        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="submit">Skicka</button>
        </div>
      </div>

      <!-- Tack -->
      <div class="form-step" id="thankYouStep">
        <h2>Tack f√∂r din f√∂rfr√•gan! üéâ</h2>
        <p style="margin-top: 16px; font-size: 16px; line-height: 1.6; text-align: center;">
          Din kampanjinfo har skickats till v√•ra experter.<br />
          Vi √•terkommer med ett TikTok-f√∂rslag inom kort.<br />
          Du hittar f√∂rfr√•gan under <strong>Analyser</strong>.
        </p>
      </div>
    </form>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    let currentStep = 0;
    const steps = document.querySelectorAll(".form-step");

    // CSRF-token med cookies
    let csrfTokenPromise = fetch("/csrf-token", { credentials: "include" })
      .then(r => r.ok ? r.json() : null)
      .then(d => d?.csrfToken || null)
      .catch(() => null);

    function showStep(index, direction) {
      steps[currentStep].classList.remove("active", "slide-up", "slide-down");
      if (direction === "next") steps[index].classList.add("slide-up");
      else steps[index].classList.add("slide-down");
      steps[index].classList.add("active");
      currentStep = index;
      updateProgressBar();
    }

    function nextStep() {
      const current = steps[currentStep];
      const inputs = current.querySelectorAll("input, textarea, select");

      // Validera radio-grupper och required inputs
      const radiosByName = new Map();
      inputs.forEach(i => { if (i.type === "radio") radiosByName.set(i.name, true); });

      for (const [name] of radiosByName) {
        const group = current.querySelectorAll(`input[type="radio"][name="${name}"]`);
        if (![...group].some(i => i.checked)) {
          alert("V√§lj ett alternativ innan du g√•r vidare.");
          return;
        }
      }
      for (const input of inputs) {
        if (input.tagName === "TEXTAREA" && input.hasAttribute("required") && input.value.trim() === "") {
          alert("Fyll i ett svar innan du g√•r vidare.");
          return;
        }
      }

      if (currentStep < steps.length - 2) showStep(currentStep + 1, "next");
    }

    function prevStep() {
      if (currentStep > 0) showStep(currentStep - 1, "prev");
    }

    function updateProgressBar() {
      const total = steps.length - 1; // sista = tack
      const percent = Math.min((currentStep / total) * 100, 100);
      document.getElementById("progressBar").style.width = percent + "%";
      document.getElementById("progressText").innerText = `Steg ${Math.min(currentStep + 1, total)} av ${total}`;
    }

    // üü¢ Skicka till servern
    document.getElementById("stepForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const data = Object.fromEntries(new FormData(this).entries());

      // Mappa till backend/admin-format
      const payload = {
        marketing: {
          tiktokAds: {
            goals: data.objective || "",          // admin-HTML anv√§nder ".goals"
            objective: data.objective || "",
            target: data.target || "",
            message: data.message || "",
            style: data.style || "",
            hashtag: data.hashtag || "",
            cta: data.cta || "",
            updatedAt: new Date().toISOString()
          }
        }
      };

      try {
        const token = await csrfTokenPromise;
        const res = await fetch("/api/customers/marketing/tiktok", {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { "x-csrf-token": token } : {})
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          let msg = `Serverfel ${res.status}`;
          try {
            const j = await res.json();
            if (j?.message || j?.error) msg = j.message || j.error;
          } catch {}
          throw new Error(msg);
        }

        showStep(currentStep + 1, "next"); // visa tack-sidan
      } catch (err) {
        alert("‚ùå Kunde inte skicka formul√§ret. " + (err?.message || "F√∂rs√∂k igen."));
        console.error(err);
      }
    });

    window.nextStep = nextStep;
    window.prevStep = prevStep;
    updateProgressBar();
  });
  </script>
</body>
</html>

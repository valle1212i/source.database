<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√•dgivning & Support</title>
  <link rel="stylesheet" href="css/radgivning.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>

  <!-- SIDOPANEL -->
  <div class="sidebar">
    <div class="logo">
      <img src="images/logo.png" alt="Logotyp" class="logo-img"/>
    </div>
    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="googleads.html"><i class="fab fa-google"></i> Google Ads</a></li>
      <li><a href="metaads.html"><i class="fab fa-facebook"></i> Meta Ads</a></li>
      <li><a href="tiktokads.html"><i class="fab fa-tiktok"></i> TikTok Ads</a></li>
      <li><a href="linkedin.html"><i class="fab fa-linkedin"></i> LinkedIn Ads</a></li>
      <li><a href="aimarknadsstudio.html"><i class="fas fa-magic"></i> AI Studio</a></li>
      <li><a href="radgivning.html" class="active"><i class="fas fa-headset"></i> R√•dgivning</a></li>
    </ul>
    <div class="help"><i class="fas fa-question-circle"></i> Hj√§lp</div>
  </div>

  <!-- INNEH√ÖLL -->
  <div class="main-content">
    <h1 class="page-title"><i class="fas fa-brain"></i> R√•dgivning & Support</h1>
    <p class="subtitle">
      Vill du ha hj√§lp av en designexpert? Skicka in ett √§rende s√• √•terkommer v√•ra marknadsr√•dgivare snabbt med v√§gledning kring annonser, kampanjer och visuellt material.
    </p>

    <div class="advice-section">
      <div class="advice-card">
        <div class="advice-text">
          <h2>Boka ett kostnadsfritt m√∂te</h2>
          <p>Vi hj√§lper dig med professionellt inneh√•ll, AI-strategier och kampanjdesign. Klicka nedan f√∂r att skicka ditt √§rende.</p>
          <button class="ai-button" id="toggleFormBtn">
            <i class="fas fa-envelope-open-text"></i> Skicka in √§rende
          </button>
        </div>
        <div class="advice-image">
          <img src="images/consulting.webp" alt="AI r√•dgivning" />
        </div>
      </div>
    </div>

    <!-- FORMUL√ÑR (f√∂renklat: inga personuppgifter kr√§vs) -->
    <form id="contactForm" class="contact-form" style="display:none;">
      <h3>üì¨ Kontakta r√•dgivningsteamet</h3>

      <div class="form-group">
        <label for="message">Beskriv kort vad du beh√∂ver hj√§lp med</label>
        <textarea id="message" name="message" rows="4" required
          placeholder="Ex: Jag vill ha hj√§lp att ta fram en annonslayout f√∂r v√•r lansering i april, och vill st√§mma av en AI-baserad bildproduktion."></textarea>
      </div>

      <div class="form-group">
        <p><strong>Hur kan vi hj√§lpa dig?</strong></p>

        <label>Beh√∂ver du hj√§lp att ta fram en designstrategi?</label>
        <div class="radio-group">
          <label><input type="radio" name="designStrategy" value="Ja" required /> Ja</label>
          <label><input type="radio" name="designStrategy" value="Nej" /> Nej</label>
        </div>

        <label>Vill du ha l√∂pande r√•dgivning under din kampanj?</label>
        <div class="radio-group">
          <label><input type="radio" name="ongoingSupport" value="Ja" required /> Ja</label>
          <label><input type="radio" name="ongoingSupport" value="Nej" /> Nej</label>
        </div>

        <label>Beh√∂ver du hj√§lp med AI-baserad bild- eller videoproduktion?</label>
        <div class="radio-group">
          <label><input type="radio" name="aiMediaHelp" value="Ja" required /> Ja</label>
          <label><input type="radio" name="aiMediaHelp" value="Nej" /> Nej</label>
        </div>
      </div>

      <div class="form-group">
        <label for="extra">√ñvriga kommentarer (valfritt)</label>
        <textarea id="extra" name="extra" rows="3" placeholder="T.ex. f√∂reslagna tider eller l√§nk till material."></textarea>
      </div>

      <button type="submit" class="ai-button" id="submitBtn">
        <i class="fas fa-paper-plane"></i> Skicka meddelande
      </button>

      <div id="formHint" class="form-hint" style="display:none;margin-top:8px;">Skickar ...</div>
    </form>

    <!-- FAQ -->
    <div class="faq-section">
      <h3><i class="fas fa-question-circle"></i> Vanliga fr√•gor</h3>
      <ul>
        <li><strong>üí∞ Vad kostar r√•dgivningen?</strong><br>Det √§r kostnadsfritt att boka f√∂rsta m√∂tet.</li>
        <li><strong>‚è± Hur l√•ng tid tar ett m√∂te?</strong><br>Ca 15‚Äì30 minuter beroende p√• ditt behov.</li>
        <li><strong>üìÇ Beh√∂ver jag ha n√•got f√§rdigt?</strong><br>Nej, vi hj√§lper dig fr√•n grunden!</li>
      </ul>
    </div>
  </div>

  <script>
    // Visa/d√∂lj formul√§r
    document.getElementById("toggleFormBtn").addEventListener("click", () => {
      const form = document.getElementById("contactForm");
      form.style.display = form.style.display === "none" ? "block" : "none";
    });

    // CSRF (om din server anv√§nder den)
    let csrfTokenPromise = fetch("/csrf-token", { credentials: "include" })
      .then(r => r.ok ? r.json() : null)
      .then(d => d?.csrfToken || null)
      .catch(() => null);

    // H√§mta ev. inloggad anv√§ndare (om backenden kopplar √§rendet till konto)
    async function getMe() {
      try {
        const r = await fetch("/api/me", { credentials: "include" });
        if (r.ok) return r.json();
      } catch {}
      return null;
    }

    // Robust inskickning: prova flera payloads och √§ven PUT som fallback
    async function postSupport(url, method, body, token) {
      const res = await fetch(url, {
        method,
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          ...(token ? { "x-csrf-token": token } : {})
        },
        body: JSON.stringify(body)
      });
      const text = await res.text().catch(() => "");
      if (!res.ok) {
        const err = new Error(`HTTP ${res.status} ${res.statusText} ‚Äî ${text.slice(0, 300)}`);
        err.status = res.status;
        throw err;
      }
      try { return JSON.parse(text) } catch { return {} }
    }

    async function trySubmit(payloadVariants) {
      const token = await csrfTokenPromise;
      // prova POST med variant 1..n
      for (const p of payloadVariants) {
        try { return await postSupport("/api/customers/marketing/support", "POST", p, token); }
        catch (e) {
          console.warn("POST variant misslyckades:", e.message);
          if (e.status && e.status !== 400 && e.status !== 405) throw e; // andra fel -> avbryt
        }
      }
      // prova PUT med variant 1..n
      for (const p of payloadVariants) {
        try { return await postSupport("/api/customers/marketing/support", "PUT", p, token); }
        catch (e) {
          console.warn("PUT variant misslyckades:", e.message);
          if (e.status && e.status !== 400 && e.status !== 405) throw e;
        }
      }
      throw new Error("Servern avvisade alla payload-varianter (400/405). Se konsol f√∂r detaljer.");
    }

    document.getElementById("contactForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      const hint = document.getElementById("formHint");

      // h√§mta f√§lt
      const message = (document.getElementById("message").value || "").trim();
      const extra = (document.getElementById("extra").value || "").trim();
      const designStrategy = (document.querySelector('input[name="designStrategy"]:checked') || {}).value || "";
      const ongoingSupport = (document.querySelector('input[name="ongoingSupport"]:checked') || {}).value || "";
      const aiMediaHelp = (document.querySelector('input[name="aiMediaHelp"]:checked') || {}).value || "";

      if (!message) {
        alert("Skriv en kort beskrivning av ditt behov.");
        return;
      }

      btn.disabled = true;
      hint.style.display = "block";
      hint.textContent = "Skickar ...";

      try {
        const me = await getMe();
        const userEmail = me?.email || me?.user?.email || undefined;

        const ticket = {
          createdAt: new Date().toISOString(),
          status: "open",
          message,
          choices: { designStrategy, ongoingSupport, aiMediaHelp },
          notes: extra || null
        };

        // Flera payload-varianter (f√∂r att matcha ev. olika backend-scheman)
        const variants = [
          // v1: full marketing.support wrapper
          {
            ...(userEmail ? { userEmail } : {}),
            marketing: {
              support: {
                status: "open",
                meetings: [],
                tickets: [ticket],
                notes: ticket.notes,
                updatedAt: new Date().toISOString()
              }
            }
          },
          // v2: support wrapper direkt
          {
            ...(userEmail ? { userEmail } : {}),
            support: { status: "open", tickets: [ticket], notes: ticket.notes }
          },
          // v3: minimalt
          {
            ...(userEmail ? { userEmail } : {}),
            ticket
          }
        ];

        await trySubmit(variants);

        hint.textContent = "‚úÖ Tack! Ditt √§rende har skickats.";
        setTimeout(() => { hint.style.display = "none"; }, 2500);
        e.target.reset();

      } catch (err) {
        console.error("Inskickningsfel:", err);
        hint.textContent = "‚ùå Kunde inte skicka √§rendet. Se konsolen f√∂r detaljer.";
        alert("Kunde inte skicka √§rendet just nu. F√∂rs√∂k igen om en stund.");
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>

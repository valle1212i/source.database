<!DOCTYPE html>
<html lang="sv">
<head>
 <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Inventarier</title>

  <!-- S√§tt sparat tema tidigt -->
  <script>
    (function(){
      try {
        var t = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', t);
      } catch(e){}
    })();
  </script>

  <!-- Gemensam tema + meny -->
  <link rel="stylesheet" href="CSS/theme.css" />
  <!-- Sidans egna kompletterande stilar (utan menyregler) -->
  <link rel="stylesheet" href="CSS/inventarier.css" />

  <!-- Ikoner -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>

<body>
  <!-- Hamburger (visas p√• mobil) -->
  <button id="menuToggle" class="hamburger-menu" aria-label="Visa meny">‚ò∞</button>

  <!-- SIDOMENY -->
  <aside class="sidebar" aria-label="Sidomeny">
    <div class="logo">
      <a href="customerportal.html">
        <img src="Images/logo.png" alt="Logotyp" class="logo-img" />
      </a>
    </div>

    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
      <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
      <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
      <li><a href="betalningslank.html"><i class="fas fa-link"></i> Betalningsl√§nk</a></li>
      <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
      <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
      <li><a href="marknadsforing.html"><i class="fas fa-bullhorn"></i> Marknadsf√∂ring</a></li>
      <li class="active"><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
      <li><a href="installningar.html"><i class="fas fa-cog"></i> Inst√§llningar</a></li>
    </ul>
    <div class="help">
      <a href="faq.html" style="color:#9ca3af; text-decoration:none;">
        <i class="fas fa-circle-question"></i> Hj√§lp / FAQ
      </a>
    </div>
 </div>
 </aside>

  <main class="main">
    <div class="profile-wrapper">
      <div class="profile-icon" id="profileToggle">??</div>
      <div class="profile-dropdown" id="profileMenu">
        <div class="profile-email" id="userEmail">Laddar...</div>
        <hr />
        <a href="#" id="switchAccount">Byt konto</a>
        <a href="#" id="openSettings">Profilinst√§llningar</a>
        <a href="#" id="logout">Logga ut</a>
      </div>
    </div>

    <h1>Inventarier</h1>
    <p>Hantera dina produkter och lagersaldo. F√• notiser n√§r produkter √§r sluts√•lda.</p>

    <section class="card">
      <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap;">
        <button id="openNewProduct" type="button" style="padding:10px 14px; border-radius:8px; border:1px solid #ccc; background:var(--card-bg,#fff); cursor:pointer;">
          ‚ûï Ny produkt
        </button>
        <input type="text" id="searchInput" placeholder="üîç S√∂k produkt, artikelnummer eller status..." onkeyup="filterTable()" style="flex:1; min-width:240px; padding:10px; border-radius:6px; border:1px solid #ccc;">
      </div>

      <table class="inventory-table" id="inventoryTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Produkt ‚¨ç</th>
            <th onclick="sortTable(1)">Artikelnummer ‚¨ç</th>
            <th onclick="sortTable(2)">Lagersaldo ‚¨ç</th>
            <th>Status</th>
            <th>Redigera</th>
          </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
      </table>
    </section>


    <section class="notifications">
      <h3>Notiser</h3>
      <ul id="notifList" style="margin:0; padding-left:18px;"></ul>
    </section>

    <!-- Modal: Ny produkt -->
    <div id="newProductModal" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:5000;">
      <div role="dialog" aria-modal="true" aria-labelledby="np-title"
           style="max-width:720px; width:92%; margin:5vh auto; background:var(--card-bg,#fff); border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
          <h2 id="np-title" style="margin:0;">Ny produkt</h2>
          <button type="button" id="np-close" aria-label="St√§ng" style="border:1px solid #ddd; background:#f7f7f7; border-radius:8px; padding:6px 10px; cursor:pointer;">‚úï</button>
        </div>

        <form id="newProductForm">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <label>Produktnamn
              <input id="np-name" type="text" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
            </label>
            <label>Artikelnummer (SKU)
              <input id="np-sku" type="text" placeholder="Ex. TS1001" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
            </label>
            <label style="grid-column:1 / -1;">Beskrivning
              <textarea id="np-desc" rows="3" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;"></textarea>
            </label>
            <label>Bild-URL (valfritt)
              <input id="np-image" type="url" placeholder="https://..." style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
            </label>
            <div>
              <div id="np-dropzone"
                   role="button"
                   tabindex="0"
                   aria-label="Sl√§pp bild h√§r eller klicka f√∂r att v√§lja"
                   style="display:flex; align-items:center; justify-content:center; text-align:center; min-height:120px; padding:14px; border:2px dashed #d1d5db; border-radius:12px; background:#fafafa; cursor:pointer;">
                <div>
                  <div style="font-weight:600; margin-bottom:4px;">Sl√§pp bild h√§r</div>
                  <div style="color:#6b7280; font-size:14px;">‚Ä¶eller klicka f√∂r att v√§lja en fil</div>
                  <div style="color:#6b7280; font-size:12px; margin-top:6px;">PNG, JPG, WEBP, GIF, HEIC/HEIF ¬∑ Max 5&nbsp;MB</div>
                </div>
              </div>
            
              <!-- Dold input som triggas av klick/Enter/Space -->
              <input id="np-image-file" type="file" accept="image/*" style="display:none;">
            
              <div id="np-image-preview" style="margin-top:8px; display:none;">
                <img id="np-image-preview-img" alt="F√∂rhandsgranskning" style="max-width:180px; max-height:120px; border-radius:8px; border:1px solid #e5e7eb;">
              </div>
            </div>                      
            <label>Antal i lager (om inga varianter)
              <input id="np-stock" type="number" min="0" value="0" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
            </label>
          </div>

          <div style="margin-top:12px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input id="np-use-variants" type="checkbox"> Anv√§nd varianter (storlek/m√•tt)
            </label>
          </div>

          <div id="np-variants" style="display:none; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <strong>Varianter</strong>
              <button id="np-add-variant" type="button" style="padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; cursor:pointer;">‚ûï L√§gg till variant</button>
            </div>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Nyckel (t.ex. S/M/L)</th>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Variant-SKU</th>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Lager</th>
                  <th style="padding:8px; border-bottom:1px solid #eee;"></th>
                </tr>
              </thead>
              <tbody id="np-variant-body"></tbody>
            </table>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
            <button type="button" id="np-cancel" style="padding:10px 14px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; cursor:pointer;">Avbryt</button>
            <button type="submit" style="padding:10px 14px; border:1px solid #1f7ae0; border-radius:8px; background:#1f7ae0; color:#fff; cursor:pointer;">Spara produkt</button>
          </div>
        </form>
      </div>
    </div>
  </main>
<!-- INVENTARIE-LOGIK: dynamisk render + SSE -->
<script>
  const savedTheme = localStorage.getItem("theme") || "light";
  document.body.classList.add(`${savedTheme}-theme`);

  const API_BASE = ""; // samma origin; √§ndra vid behov
  let CSRF_TOKEN = null;

  // === CSRF ===
  async function initCsrf() {
    // credentials:'include' om session-cookies anv√§nds
    const r = await fetch('/csrf-token', { credentials: 'include' });
    const { csrfToken } = await r.json();
    CSRF_TOKEN = csrfToken;
  }

  // === Statushj√§lp ===
  function statusFor(stock){
    if (stock === 0) return { text: "Sluts√•ld", className: "status-soldout" };
    if (stock < 5)  return { text: "L√•gt lager", className: "status-low" };
    return { text: "I lager", className: "status-instock" };
  }

  // === Render ===
  // === Render-hj√§lpare (s√§ker DOM) ===
  function createRow(item){
    const s = statusFor(item.stock);

    const tr = document.createElement("tr");
    if (item.id)  tr.dataset.id  = item.id;
    if (item.sku) tr.dataset.sku = item.sku;

    const tdName = document.createElement("td");
    tdName.appendChild(document.createTextNode(item.name ?? ""));

    const tdSku = document.createElement("td");
    tdSku.appendChild(document.createTextNode(item.sku ?? ""));

    const tdStock = document.createElement("td");
    tdStock.className = "stock-cell";
    tdStock.appendChild(document.createTextNode(String(item.stock ?? "")));

    const tdStatus = document.createElement("td");
    tdStatus.className = s.className;
    tdStatus.appendChild(document.createTextNode(s.text));

    const tdEdit = document.createElement("td");
    const icon = document.createElement("i");
    icon.className = "fas fa-edit";
    icon.title = "Redigera";
    icon.addEventListener("click", () => toggleEdit(icon));
    tdEdit.appendChild(icon);

    tr.append(tdName, tdSku, tdStock, tdStatus, tdEdit);
    return tr;
  }

  function render(items){
  const tbody = document.getElementById("inventoryBody");
  while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

  items.forEach(item => {
    const s = statusFor(item.stock);

    const tr = document.createElement("tr");
    if (item.id)  tr.dataset.id  = item.id;
    if (item.sku) tr.dataset.sku = item.sku;

    const tdName = document.createElement("td");
    tdName.appendChild(document.createTextNode(item.name ?? ""));

    const tdSku = document.createElement("td");
    tdSku.appendChild(document.createTextNode(item.sku ?? ""));

    const tdStock = document.createElement("td");
    tdStock.className = "stock-cell";
    tdStock.appendChild(document.createTextNode(String(item.stock ?? "")));

    const tdStatus = document.createElement("td");
    tdStatus.className = s.className;
    tdStatus.appendChild(document.createTextNode(s.text));

    const tdEdit = document.createElement("td");
    const icon = document.createElement("i");
    icon.className = "fas fa-edit";
    icon.title = "Redigera";
    icon.addEventListener("click", () => toggleEdit(icon));
    tdEdit.appendChild(icon);

    tr.append(tdName, tdSku, tdStock, tdStatus, tdEdit);
    tbody.appendChild(tr);
  });

  refreshNotifications();
}

  // === S√∂k & sort ===
  function filterTable() {
    const q = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#inventoryBody tr").forEach(row => {
      row.style.display = Array.from(row.cells).some(td => td.textContent.toLowerCase().includes(q)) ? "" : "none";
    });
  }
  function sortTable(colIndex) {
    const tbody = document.getElementById("inventoryBody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a, b) => {
      const A = a.cells[colIndex].textContent.trim();
      const B = b.cells[colIndex].textContent.trim();
      return isNaN(A - B) ? A.localeCompare(B) : Number(A) - Number(B);
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  // === Modal "Ny produkt" + Varianter + Spara + Upload ===
  function qs(id){ return document.getElementById(id); }

  function openNewProduct(){
    resetNewProductForm();
    const modal = qs('newProductModal');
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden','false');
    qs('np-name').focus();
  }
  function closeNewProduct(){
    const modal = qs('newProductModal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }
  function resetNewProductForm(){
    qs('newProductForm').reset();
    qs('np-variants').style.display = 'none';
    const body = qs('np-variant-body');
    while (body.firstChild) body.removeChild(body.firstChild);
    const p = qs('np-image-preview'); const img = qs('np-image-preview-img');
    if (p) p.style.display = 'none';
    if (img) img.src = '';
  }

  function addVariantRow(seed = { key:'', sku:'', stock:0 }){
    const tr = document.createElement('tr');
    function tdWrap(el){ const td = document.createElement('td'); td.style.padding='6px 8px'; td.appendChild(el); return td; }

    const keyInput = document.createElement('input');
    keyInput.type = 'text'; keyInput.value = seed.key || '';
    keyInput.placeholder = 'S / M / L'; keyInput.style.width='100%'; keyInput.style.padding='8px'; keyInput.style.border='1px solid #ccc'; keyInput.style.borderRadius='6px';

    const skuInput = document.createElement('input');
    skuInput.type = 'text'; skuInput.value = seed.sku || '';
    skuInput.placeholder = 'SKU-variant'; skuInput.style.width='100%'; skuInput.style.padding='8px'; skuInput.style.border='1px solid #ccc'; skuInput.style.borderRadius='6px';

    const stockInput = document.createElement('input');
    stockInput.type = 'number'; stockInput.min = '0'; stockInput.value = String(seed.stock ?? 0);
    stockInput.style.width='100%'; stockInput.style.padding='8px'; stockInput.style.border='1px solid #ccc'; stockInput.style.borderRadius='6px';

    const delBtn = document.createElement('button');
    delBtn.type = 'button'; delBtn.textContent = 'Ta bort';
    delBtn.style.padding='6px 10px'; delBtn.style.border='1px solid #ccc'; delBtn.style.borderRadius='6px'; delBtn.style.background='#f7f7f7'; delBtn.style.cursor='pointer';
    delBtn.onclick = () => tr.remove();

    tr.append(
      tdWrap(keyInput),
      tdWrap(skuInput),
      tdWrap(stockInput),
      tdWrap(delBtn)
    );
    qs('np-variant-body').appendChild(tr);
  }

  function collectVariants(){
    const rows = Array.from(qs('np-variant-body').querySelectorAll('tr'));
    const out = [];
    for (const r of rows){
      const [keyEl, skuEl, stockEl] = r.querySelectorAll('input');
      const key = (keyEl.value || '').trim();
      const sku = (skuEl.value || '').trim();
      const stock = Math.max(0, Number(stockEl.value || 0));
      if (key || sku){ out.push({ key, sku, stock }); }
    }
    return out;
  }

  async function uploadImage(file){
    if (!file) throw new Error('Ingen fil vald');
    if (!CSRF_TOKEN) await initCsrf();
    const fd = new FormData();
    fd.append('image', file);
    const r = await fetch(API_BASE + '/api/inventory/upload', {
      method: 'POST',
      credentials: 'include',
      headers: { 'X-CSRF-Token': CSRF_TOKEN }, // csurf accepterar denna header
      body: fd
    });
    const d = await r.json();
    if (!r.ok || !d?.success) throw new Error(d?.message || 'Misslyckad uppladdning');
    return d.url; // t.ex. /uploads/123456-file.jpg
  }

  async function onImageFileChange(e){
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      const url = await uploadImage(file);
      const urlInput = qs('np-image');
      urlInput.value = url;

      const img = qs('np-image-preview-img');
      const wrap = qs('np-image-preview');
      if (img && wrap){
        img.src = url;
        wrap.style.display = 'block';
      }
    }catch(err){
      console.error(err);
      alert(err.message || 'Kunde inte ladda upp bilden.');
      e.target.value = ''; // resetta filf√§ltet
    }
  }

  async function submitNewProduct(e){
    e.preventDefault();
    const name = (qs('np-name').value || '').trim();
    const sku = (qs('np-sku').value || '').trim();
    const description = (qs('np-desc').value || '').trim();
    const imageUrl = (qs('np-image').value || '').trim(); // kan komma fr√•n uppladdningen
    const useVariants = qs('np-use-variants').checked;
    const stock = Math.max(0, Number(qs('np-stock').value || 0));

    const payload = { name, description, imageUrl };
    if (useVariants){
      const variants = collectVariants();
      if (!variants.length) { alert('L√§gg till minst en variant.'); return; }
      payload.variants = variants;
      if (sku) payload.sku = sku; // valfri topp-SKU
    } else {
      payload.sku = sku;
      payload.stock = stock;
    }

    try{
      if (!CSRF_TOKEN) await initCsrf();
      const r = await fetch(API_BASE + '/api/inventory/items', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': CSRF_TOKEN
        },
        body: JSON.stringify(payload)
      });
      const d = await r.json();
      if (!r.ok || !d.success){ throw new Error(d?.error || 'Kunde inte spara produkten'); }
      const snap = await fetch(API_BASE + '/api/inventory', { credentials:'include' }).then(x=>x.json());
      if (snap?.success) render(snap.items);
      closeNewProduct();
    }catch(err){
      console.error(err);
      alert(err.message || 'N√•got gick fel vid sparning.');
    }
  }

   // === Drag & drop (bild) ===
   function setupDropzone(){
    const dz = qs('np-dropzone');
    const fileInput = qs('np-image-file');
    if (!dz || !fileInput) return;

    function highlight(on){
      dz.style.borderColor = on ? '#1f7ae0' : '#d1d5db';
      dz.style.background = on ? '#f5f9ff' : '#fafafa';
    }

    // Klick + tangentbord √∂ppnar filv√§ljare
    dz.addEventListener('click', () => fileInput.click());
    dz.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
    });

    // F√∂rhindra default vid drag events + highlight
    ['dragenter','dragover'].forEach(ev => {
      dz.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); highlight(true); });
    });
    ['dragleave','dragend'].forEach(ev => {
      dz.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); highlight(false); });
    });

    dz.addEventListener('drop', async (e) => {
      e.preventDefault(); e.stopPropagation(); highlight(false);
      const file = e.dataTransfer?.files?.[0];
      if (!file) return;
      try{
        const url = await uploadImage(file);
        const urlInput = qs('np-image');
        if (urlInput) urlInput.value = url;
        const img = qs('np-image-preview-img');
        const wrap = qs('np-image-preview');
        if (img && wrap){ img.src = url; wrap.style.display = 'block'; }
      }catch(err){
        console.error(err);
        alert(err.message || 'Kunde inte ladda upp bilden.');
      }
    });
  }

  // === Redigering / API ===
  function updateStatus(stock, statusCell) {
    const s = statusFor(stock);
    statusCell.textContent = s.text;
    statusCell.className = s.className;
  }


  function callStockAPI(productId, quantity, op){
    const endpoint = op === "return" ? "/api/inventory/return" : "/api/inventory/buy";
    // S√§kerst√§ll token
    if (!CSRF_TOKEN) {
      console.warn("CSRF-token saknas, f√∂rs√∂ker h√§mta om...");
      return initCsrf().then(() => callStockAPI(productId, quantity, op));
    }
    fetch(API_BASE + endpoint, {
      method: "POST",
      credentials: "include", // viktigt om cookies beh√∂vs
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": CSRF_TOKEN
      },
      body: JSON.stringify({ productId, quantity })
    })
    .then(res => { if (!res.ok) throw new Error("API-fel"); return res.json(); })
    .catch(err => {
      console.error("Fel vid API-anrop:", err);
      alert("Kunde inte uppdatera lagret mot servern.");
    });
  }

  function toggleEdit(icon) {
    const td = icon.parentElement;
    const row = td.parentElement;
    const productId = row.dataset.id || row.cells[1].textContent.trim(); // id eller SKU
    const stockCell = row.cells[2];
    const statusCell = row.cells[3];

    const existing = td.querySelector(".edit-controls");
    if (existing) { existing.remove(); return; }

    let stock = parseInt(stockCell.textContent.trim()) || 0;

    const input = document.createElement("input");
    input.type = "number";
    input.value = stock;
    input.style.width = "60px";
    input.style.marginRight = "6px";
    input.onchange = () => {
      const newStock = parseInt(input.value);
      const diff = newStock - stock;
      if (!isNaN(newStock) && diff !== 0) {
        const op = diff > 0 ? "return" : "buy";
        callStockAPI(productId, Math.abs(diff), op);
        stock = newStock;
        stockCell.textContent = stock;
        updateStatus(stock, statusCell);
      }
    };
    stockCell.innerHTML = "";
    stockCell.appendChild(input);

    const controls = document.createElement("div");
    controls.className = "edit-controls";

    const minusBtn = document.createElement("button");
    minusBtn.textContent = "‚ûñ";
    minusBtn.onclick = () => {
      if (stock > 0) {
        callStockAPI(productId, 1, "buy");
        stock--; input.value = stock; stockCell.textContent = stock; updateStatus(stock, statusCell);
      }
    };

    const plusBtn = document.createElement("button");
    plusBtn.textContent = "‚ûï";
    plusBtn.onclick = () => {
      callStockAPI(productId, 1, "return");
      stock++; input.value = stock; stockCell.textContent = stock; updateStatus(stock, statusCell);
    };

    [minusBtn, plusBtn].forEach(btn => {
      btn.style.marginLeft = "6px";
      btn.style.padding = "2px 6px";
      btn.style.fontSize = "12px";
      btn.style.cursor = "pointer";
    });

    controls.appendChild(minusBtn);
    controls.appendChild(plusBtn);
    td.appendChild(controls);
  }

  // === Notiser ===
  function refreshNotifications(){
    const list = document.getElementById("notifList");
    if (!list) return;

    // T√∂m listan s√§kert
    while (list.firstChild) list.removeChild(list.firstChild);

    const rows = Array.from(document.querySelectorAll("#inventoryBody tr"));
    const soldOut = rows
      .filter(r => r.cells[3].classList.contains("status-soldout"))
      .map(r => r.cells[0].textContent.trim());

    if (soldOut.length === 0) {
      const li = document.createElement("li");
      li.appendChild(document.createTextNode("Inga kritiska notiser just nu."));
      list.appendChild(li);
      return;
    }

    soldOut.forEach((name) => {
      const li = document.createElement("li");
      li.appendChild(document.createTextNode("Produkten "));
      const strong = document.createElement("strong");
      strong.appendChild(document.createTextNode(name));
      li.appendChild(strong);
      li.appendChild(document.createTextNode(" √§r sluts√•ld. Uppdatera lagersaldo eller inaktivera i webbshopen."));
      list.appendChild(li);
    });
  }

  // === Realtid (SSE) + initial data ===
  function connectSSE(){
    const ev = new EventSource(API_BASE + "/api/inventory/stream");
    ev.onmessage = (e) => {
      const p = JSON.parse(e.data || "{}");
      if (p.type === "snapshot" && Array.isArray(p.items)) render(p.items);
      if (p.type === "stock" && p.item){
        const row = document.querySelector(`tr[data-id="${p.item.id}"]`);
        if (row){
          row.querySelector(".stock-cell").textContent = p.item.stock;
          updateStatus(p.item.stock, row.cells[3]);
        } else {
                    const tbody = document.getElementById("inventoryBody");
          tbody.appendChild(createRow(p.item));
        }
        refreshNotifications();
      }
    };
    ev.onerror = () => { console.warn("SSE tappad, f√∂rs√∂ker igen om 3s..."); setTimeout(connectSSE, 3000); };
  }

  // Init ‚Äì h√§mta CSRF f√∂rst, sedan data + SSE
  async function initInventory(){
    await initCsrf();
    fetch(API_BASE + "/api/inventory", { credentials: 'include' })
      .then(r => r.json())
      .then(d => { if (d.success) render(d.items); });
    connectSSE();

    // Wire modal/UI
    const btn = document.getElementById('openNewProduct');
    if (btn) btn.addEventListener('click', openNewProduct);
    const useVar = document.getElementById('np-use-variants');
    if (useVar) useVar.addEventListener('change', () => {
      document.getElementById('np-variants').style.display = useVar.checked ? 'block' : 'none';
    });
    const addVar = document.getElementById('np-add-variant');
    if (addVar) addVar.addEventListener('click', () => addVariantRow());
    const closeBtn = document.getElementById('np-close');
    if (closeBtn) closeBtn.addEventListener('click', closeNewProduct);
    const cancelBtn = document.getElementById('np-cancel');
    if (cancelBtn) cancelBtn.addEventListener('click', closeNewProduct);
    const form = document.getElementById('newProductForm');
    if (form) form.addEventListener('submit', submitNewProduct);

    // Upload: filf√§lt + drag & drop
    const fileInput = document.getElementById('np-image-file');
    if (fileInput) fileInput.addEventListener('change', onImageFileChange);
    setupDropzone();
  }
  initInventory();

  // Exponera f√∂r HTML-attribut
  window.filterTable = filterTable;
  window.sortTable = sortTable;
  window.toggleEdit = toggleEdit;
</script>

  <!-- PROFIL/MENY (of√∂r√§ndrat) -->
  <script>
    const toggle = document.getElementById('profileToggle');
    const menu = document.getElementById('profileMenu');

    toggle.addEventListener('click', () => {
      const isOpen = menu.style.display === 'flex';
      menu.style.display = isOpen ? 'none' : 'flex';
      toggle.classList.toggle('open', !isOpen);
    });

    window.addEventListener('click', function (e) {
      if (!document.querySelector('.profile-wrapper').contains(e.target)) {
        menu.style.display = 'none';
        toggle.classList.remove('open');
      }
    });

    document.getElementById("switchAccount").addEventListener("click", function (e) {
      e.preventDefault();
      if (confirm("Vill du logga ut och byta konto?")) {
        window.location.href = "login.html";
      }
    });

    document.getElementById("openSettings").addEventListener("click", function (e) {
      e.preventDefault();
      window.location.href = "profile.html";
    });

    document.getElementById("logout").addEventListener("click", function (e) {
      e.preventDefault();
      if (confirm("√Ñr du s√§ker p√• att du vill logga ut?")) {
        fetch('/logout', { method: 'GET', credentials: 'include' })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              localStorage.clear();
              window.location.href = "/login.html";
            } else {
              alert("Utloggning misslyckades.");
            }
          })
          .catch(err => {
            console.error("Fel vid utloggning:", err);
            alert("Kunde inte logga ut.");
          });
      }
    });

    function toggleSidebar() {
      const sidebar = document.querySelector(".sidebar");
      const isActive = sidebar.classList.contains("active");
      sidebar.classList.toggle("active", !isActive);
      document.body.classList.toggle("menu-open", !isActive);
    }

    // St√§ng menyn p√• mobil vid klick utanf√∂r
    window.addEventListener("click", (e) => {
      const sidebar = document.querySelector(".sidebar");
      const menuBtn = document.getElementById("menuToggle");
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) return;
      const clickInMenu = sidebar.contains(e.target);
      const clickOnBtn  = menuBtn && menuBtn.contains(e.target);
      if (!clickInMenu && !clickOnBtn) {
        sidebar.classList.remove("active");
        document.body.classList.remove("menu-open");
      }
    });
  </script>
  <script>
  // ...ditt befintliga script...

  const menuBtn = document.getElementById("menuToggle");
  if (menuBtn) {
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleSidebar();
    });
  }
</script>

<script src="/js/logout.js"></script>
</body>
</html>

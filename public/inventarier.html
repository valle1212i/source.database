<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventarier</title>
  <link rel="stylesheet" href="CSS/inventarier.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>
  <button id="menuToggle" class="hamburger-menu" aria-label="Visa meny" onclick="toggleSidebar()">‚ò∞</button>
  <div class="sidebar">
    <div class="logo">
      <a href="customerportal.html">
        <img src="images/logo.png" alt="Logotyp" class="logo-img" />
      </a>
    </div>
    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
      <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
      <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
      <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
      <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
      <li><a href="marknadsf√∂ring.html"><i class="fas fa-bullhorn"></i> Marknadsf√∂ring</a></li>
      <li class="active"><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
      <li><a href="installningar.html"><i class="fas fa-cog"></i> Inst√§llningar</a></li>
    </ul>
    <div class="help">
      <a href="faq.html"><i class="fas fa-question-circle"></i> Hj√§lp</a>
    </div>
  </div>

  <main class="main">
    <div class="profile-wrapper">
      <div class="profile-icon" id="profileToggle">??</div>
      <div class="profile-dropdown" id="profileMenu">
        <div class="profile-email" id="userEmail">Laddar...</div>
        <hr />
        <a href="#" id="switchAccount">Byt konto</a>
        <a href="#" id="openSettings">Profilinst√§llningar</a>
        <a href="#" id="logout">Logga ut</a>
      </div>
    </div>

    <h1>Inventarier</h1>
    <p>Hantera dina produkter och lagersaldo. F√• notiser n√§r produkter √§r sluts√•lda.</p>

    <section class="card">
      <input type="text" id="searchInput" placeholder="üîç S√∂k produkt, artikelnummer eller status..." onkeyup="filterTable()" style="margin-bottom: 15px; padding: 10px; width: 100%; border-radius: 6px; border: 1px solid #ccc;">

      <table class="inventory-table" id="inventoryTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Produkt ‚¨ç</th>
            <th onclick="sortTable(1)">Artikelnummer ‚¨ç</th>
            <th onclick="sortTable(2)">Lagersaldo ‚¨ç</th>
            <th>Status</th>
            <th>Redigera</th>
          </tr>
        </thead>
        <!-- ENDA tbody: fylls via JS -->
        <tbody id="inventoryBody"></tbody>
      </table>
    </section>

    <section class="notifications">
      <h3>Notiser</h3>
      <ul id="notifList" style="margin:0; padding-left:18px;"></ul>
    </section>
  </main>
<!-- INVENTARIE-LOGIK: dynamisk render + SSE -->
<script>
  const savedTheme = localStorage.getItem("theme") || "light";
  document.body.classList.add(`${savedTheme}-theme`);

  const API_BASE = ""; // samma origin; √§ndra vid behov
  let CSRF_TOKEN = null;

  // === CSRF ===
  async function initCsrf() {
    // credentials:'include' om session-cookies anv√§nds
    const r = await fetch('/csrf-token', { credentials: 'include' });
    const { csrfToken } = await r.json();
    CSRF_TOKEN = csrfToken;
  }

  // === Statushj√§lp ===
  function statusFor(stock){
    if (stock === 0) return { text: "Sluts√•ld", className: "status-soldout" };
    if (stock < 5)  return { text: "L√•gt lager", className: "status-low" };
    return { text: "I lager", className: "status-instock" };
  }

  // === Render ===
  function rowHTML(item){
    const s = statusFor(item.stock);
    return `
      <tr data-id="${item.id}" data-sku="${item.sku}">
        <td>${item.name}</td>
        <td>${item.sku}</td>
        <td class="stock-cell">${item.stock}</td>
        <td class="${s.className}">${s.text}</td>
        <td><i class="fas fa-edit" title="Redigera" onclick="toggleEdit(this)"></i></td>
      </tr>`;
  }

  function render(items){
    const tbody = document.getElementById("inventoryBody");
    tbody.innerHTML = items.map(rowHTML).join("");
    refreshNotifications();
  }

  // === S√∂k & sort ===
  function filterTable() {
    const q = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#inventoryBody tr").forEach(row => {
      row.style.display = Array.from(row.cells).some(td => td.textContent.toLowerCase().includes(q)) ? "" : "none";
    });
  }
  function sortTable(colIndex) {
    const tbody = document.getElementById("inventoryBody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a, b) => {
      const A = a.cells[colIndex].textContent.trim();
      const B = b.cells[colIndex].textContent.trim();
      return isNaN(A - B) ? A.localeCompare(B) : Number(A) - Number(B);
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  // === Redigering / API ===
  function updateStatus(stock, statusCell) {
    const s = statusFor(stock);
    statusCell.textContent = s.text;
    statusCell.className = s.className;
  }

  function callStockAPI(productId, quantity, op){
    const endpoint = op === "return" ? "/api/inventory/return" : "/api/inventory/buy";
    // S√§kerst√§ll token
    if (!CSRF_TOKEN) {
      console.warn("CSRF-token saknas, f√∂rs√∂ker h√§mta om...");
      return initCsrf().then(() => callStockAPI(productId, quantity, op));
    }
    fetch(API_BASE + endpoint, {
      method: "POST",
      credentials: "include", // viktigt om cookies beh√∂vs
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": CSRF_TOKEN
      },
      body: JSON.stringify({ productId, quantity })
    })
    .then(res => { if (!res.ok) throw new Error("API-fel"); return res.json(); })
    .catch(err => {
      console.error("Fel vid API-anrop:", err);
      alert("Kunde inte uppdatera lagret mot servern.");
    });
  }

  function toggleEdit(icon) {
    const td = icon.parentElement;
    const row = td.parentElement;
    const productId = row.dataset.id || row.cells[1].textContent.trim(); // id eller SKU
    const stockCell = row.cells[2];
    const statusCell = row.cells[3];

    const existing = td.querySelector(".edit-controls");
    if (existing) { existing.remove(); return; }

    let stock = parseInt(stockCell.textContent.trim()) || 0;

    const input = document.createElement("input");
    input.type = "number";
    input.value = stock;
    input.style.width = "60px";
    input.style.marginRight = "6px";
    input.onchange = () => {
      const newStock = parseInt(input.value);
      const diff = newStock - stock;
      if (!isNaN(newStock) && diff !== 0) {
        const op = diff > 0 ? "return" : "buy";
        callStockAPI(productId, Math.abs(diff), op);
        stock = newStock;
        stockCell.textContent = stock;
        updateStatus(stock, statusCell);
      }
    };
    stockCell.innerHTML = "";
    stockCell.appendChild(input);

    const controls = document.createElement("div");
    controls.className = "edit-controls";

    const minusBtn = document.createElement("button");
    minusBtn.textContent = "‚ûñ";
    minusBtn.onclick = () => {
      if (stock > 0) {
        callStockAPI(productId, 1, "buy");
        stock--; input.value = stock; stockCell.textContent = stock; updateStatus(stock, statusCell);
      }
    };

    const plusBtn = document.createElement("button");
    plusBtn.textContent = "‚ûï";
    plusBtn.onclick = () => {
      callStockAPI(productId, 1, "return");
      stock++; input.value = stock; stockCell.textContent = stock; updateStatus(stock, statusCell);
    };

    [minusBtn, plusBtn].forEach(btn => {
      btn.style.marginLeft = "6px";
      btn.style.padding = "2px 6px";
      btn.style.fontSize = "12px";
      btn.style.cursor = "pointer";
    });

    controls.appendChild(minusBtn);
    controls.appendChild(plusBtn);
    td.appendChild(controls);
  }

  // === Notiser ===
  function refreshNotifications(){
    const list = document.getElementById("notifList");
    if (!list) return;
    const rows = Array.from(document.querySelectorAll("#inventoryBody tr"));
    const soldOut = rows.filter(r => r.cells[3].classList.contains("status-soldout"))
                        .map(r => r.cells[0].textContent.trim());
    list.innerHTML = soldOut.length
      ? soldOut.map(n => `<li>Produkten <strong>${n}</strong> √§r sluts√•ld. Uppdatera lagersaldo eller inaktivera i webbshopen.</li>`).join("")
      : `<li>Inga kritiska notiser just nu.</li>`;
  }

  // === Realtid (SSE) + initial data ===
  function connectSSE(){
    const ev = new EventSource(API_BASE + "/api/inventory/stream");
    ev.onmessage = (e) => {
      const p = JSON.parse(e.data || "{}");
      if (p.type === "snapshot" && Array.isArray(p.items)) render(p.items);
      if (p.type === "stock" && p.item){
        const row = document.querySelector(`tr[data-id="${p.item.id}"]`);
        if (row){
          row.querySelector(".stock-cell").textContent = p.item.stock;
          updateStatus(p.item.stock, row.cells[3]);
        } else {
          document.getElementById("inventoryBody").insertAdjacentHTML("beforeend", rowHTML(p.item));
        }
        refreshNotifications();
      }
    };
    ev.onerror = () => { console.warn("SSE tappad, f√∂rs√∂ker igen om 3s..."); setTimeout(connectSSE, 3000); };
  }

  // Init ‚Äì h√§mta CSRF f√∂rst, sedan data + SSE
  async function initInventory(){
    await initCsrf();
    fetch(API_BASE + "/api/inventory", { credentials: 'include' })
      .then(r => r.json())
      .then(d => { if (d.success) render(d.items); });
    connectSSE();
  }
  initInventory();

  // Exponera f√∂r HTML-attribut
  window.filterTable = filterTable;
  window.sortTable = sortTable;
  window.toggleEdit = toggleEdit;
</script>

  <!-- PROFIL/MENY (of√∂r√§ndrat) -->
  <script>
    const toggle = document.getElementById('profileToggle');
    const menu = document.getElementById('profileMenu');

    toggle.addEventListener('click', () => {
      const isOpen = menu.style.display === 'flex';
      menu.style.display = isOpen ? 'none' : 'flex';
      toggle.classList.toggle('open', !isOpen);
    });

    window.addEventListener('click', function (e) {
      if (!document.querySelector('.profile-wrapper').contains(e.target)) {
        menu.style.display = 'none';
        toggle.classList.remove('open');
      }
    });

    document.getElementById("switchAccount").addEventListener("click", function (e) {
      e.preventDefault();
      if (confirm("Vill du logga ut och byta konto?")) {
        window.location.href = "login.html";
      }
    });

    document.getElementById("openSettings").addEventListener("click", function (e) {
      e.preventDefault();
      window.location.href = "profile.html";
    });

    document.getElementById("logout").addEventListener("click", function (e) {
      e.preventDefault();
      if (confirm("√Ñr du s√§ker p√• att du vill logga ut?")) {
        fetch('/logout', { method: 'GET', credentials: 'include' })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              localStorage.clear();
              window.location.href = "/login.html";
            } else {
              alert("Utloggning misslyckades.");
            }
          })
          .catch(err => {
            console.error("Fel vid utloggning:", err);
            alert("Kunde inte logga ut.");
          });
      }
    });

    function toggleSidebar() {
      const sidebar = document.querySelector(".sidebar");
      const isActive = sidebar.classList.contains("active");
      sidebar.classList.toggle("active", !isActive);
      document.body.classList.toggle("menu-open", !isActive);
    }

    // St√§ng menyn p√• mobil vid klick utanf√∂r
    window.addEventListener("click", (e) => {
      const sidebar = document.querySelector(".sidebar");
      const menuBtn = document.getElementById("menuToggle");
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) return;
      const clickInMenu = sidebar.contains(e.target);
      const clickOnBtn  = menuBtn && menuBtn.contains(e.target);
      if (!clickInMenu && !clickOnBtn) {
        sidebar.classList.remove("active");
        document.body.classList.remove("menu-open");
      }
    });
  </script>
<script src="/js/logout.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kundportal - Startsida</title>
  <link rel="stylesheet" href="CSS/customerportal.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
  <div class="logo">
    <a href="customerportal.html">
      <img src="images/logo.png" alt="Logotyp" class="logo-img" />
    </a>
  </div>
<ul class="nav-menu">
  <li class="active"><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
  <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
  <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
  <li><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
  <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
  <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
  <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
  <li><a href="marknadsf√∂ring.html"><i class="fas fa-bullhorn"></i> Marknadsf√∂ring</a></li>
  <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
  <li><a href="installningar.html"><i class="fas fa-cog"></i> Inst√§llningar</a></li>
</ul>
<div class="help">
  <a href="faq.html"><i class="fas fa-question-circle"></i> Hj√§lp</a>
</div>
</div>

<!-- Hamburger-meny (visas bara p√• sm√• sk√§rmar) -->
<button id="menuToggle" class="hamburger-menu" aria-label="Visa meny">
  &#9776;
</button>

  <div class="main">
  <div class="header">V√§lkommen tillbaka!</div>

  <script>
    async function loadUserGreeting() {
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (!res.ok) throw new Error('Inte inloggad');

        const data = await res.json();
        const fullName = data.name || "anv√§ndare";
        const firstName = fullName.trim().split(" ")[0];

        const header = document.querySelector(".header");
        if (header) {
          header.textContent = `V√§lkommen tillbaka, ${firstName}!`;
        }
      } catch (err) {
        console.error("Kunde inte h√§mta anv√§ndarinformation:", err);
        const header = document.querySelector(".header");
        if (header) {
          header.textContent = "V√§lkommen tillbaka!";
        }
      }
    }

    document.addEventListener("DOMContentLoaded", loadUserGreeting);
  </script>

  <!-- Profilikonen ska ligga utanf√∂r grid -->
  <div class="profile-wrapper">
    <div class="profile-icon" id="profileToggle"></div>
    <div class="profile-dropdown" id="profileMenu">
      <div class="profile-email" id="userEmail">Laddar...</div>
      <hr />
      <a href="#" id="switchAccount">Byt konto</a>
      <a href="#" id="openSettings">Profilinst√§llningar</a>
      <a href="#" id="logout">Logga ut</a>
    </div>
  </div>

  <!-- Huvudinneh√•ll -->
  <div class="dashboard-container">

   <!-- Diagramkort -->
<div class="card sales-card wide-3">
  <div class="circle-widget">
    <div class="chart-area">
      <canvas id="salesChart" height="140"></canvas>
    </div>
    <div class="sales-info">
      <h3>F√∂rs√§ljning senaste 7 dagarna</h3>
      <hr class="title-underline">
      <div class="amount">752,000 SEK</div>
      <hr class="amount-underline">
    </div>
  </div>
</div>


    <!-- Support√§renden -->
    <div class="card">
      <h3>Tidigare √§reden via v√•r support</h3>
      <div class="table-container">
        <table class="support-table">
          <thead>
            <tr>
              <th>√Ñrende-ID</th>
              <th>Datum</th>
              <th>Kundnamn</th>
              <th>√Ñrende</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  
  <!-- AI Insights (ny version) -->
<div class="card" id="aiInsightsCard">
  <h3>üìà AI Insights</h3>
  <div id="aiInsightsContent">Laddar AI-insikter...</div>
</div>



      <div class="card latest-message">
        <div class="card-header aligned">
          <i class="fas fa-comments chat-icon"></i>
          <h3>Senaste meddelande fr√•n kund</h3>
        </div>
        <div class="chat-bubble">
          Jag vill veta status p√• min order #10235.
          <div class="message-meta">
            <span class="customer-name">Anna Svensson</span> ¬∑ 
            <span class="timestamp">2025-06-30, kl. 14:12</span>
          </div>
        </div>
      </div>

      <div class="card">
  <h3>Visningar p√• hemsidan</h3>
  <div class="mini-chart-container">
    <canvas id="websiteViewsMiniChart" height="60"></canvas>
  </div>
  <div class="chart-indicator-box">
    <span id="change" class="change">Laddar...</span>
    <span id="todayCount" class="total"><strong>...</strong></span>
  </div>
</div>
      <div class="card"><h3>Mest k√∂pt produkt</h3><p>Pro Plus-paketet</p></div>
      <div class="card"><h3>Totalt antal ordrar</h3><p>1 820 ordrar registrerade</p></div>
      <div class="card"><h3>Utbetalningar</h3><p>Senaste: 215 000 SEK den 20 juni</p></div>
      <div class="card"><h3>Senaste order</h3><p>Order #1820 - levererad 24 juni</p></div>

      
      
      <div class="card"><h3>Kommande m√∂ten</h3><p>N√§sta m√∂te: 27 juni kl. 14:00</p><p>M√∂te med marknadsteamet</p></div>

      <div class="card live-chat dark">
        <h3>Live Chat</h3>
        <p>"Kan du skicka senaste rapporten?" - kund</p>
        <button onclick="window.location.href='chatwindow.html'">Starta chatt med oss</button>
      </div>

      <div class="card">
        <h3>Support√§renden</h3>
        <ul>
          <li>Inloggningsproblem - <span class="status open">√ñppen</span></li>
          <li>Buggrapport - <span class="status progress">P√•g√•r</span></li>
          <li>Funktion√∂nskem√•l - <span class="status closed">St√§ngd</span></li>
        </ul>
      </div>

      <div class="card ai-assistant">
  <div class="ai-header">
    <i class="fas fa-robot ai-icon"></i>
    <div>
      <h3>AI Assistent</h3>
      <p class="ai-subtext">F√∂resl√•r svar, analyser och hj√§lp i realtid.</p>
    </div>
  </div>

  <textarea id="aiMessage" rows="3" placeholder="St√§ll en fr√•ga till AI..."></textarea>
  
  <button class="ai-button" onclick="askAI()">Skicka fr√•ga</button>
  
  <div id="aiResponse">
  <div id="loadingAnimation" class="loader" style="display: none;"></div>
</div>


  <!-- Chart.js -->
  <script>
  async function renderPageViewChart() {
    try {
      const res = await fetch("/api/pageviews/summary");
      const data = await res.json();

      const ctx = document.getElementById("websiteViewsMiniChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: data.labels.map(date =>
  new Date(date).toLocaleDateString("sv-SE", {
    weekday: "short",
    day: "numeric",
    month: "short"
  })
),
          datasets: [{
            label: "Visningar",
            data: data.counts,
            borderColor: "#3b82f6",
            backgroundColor: "rgba(59, 130, 246, 0.08)",
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHitRadius: 10,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              backgroundColor: '#111827',
              titleColor: '#ffffff',
              bodyColor: '#d1d5db',
              callbacks: {
                label: function (context) {
                  return context.parsed.y + " visningar";
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "#6b7280",  // Tailwind text-gray-500
                maxRotation: 0,
                autoSkip: true,
                callback: function (val, index, ticks) {
                  const label = this.getLabelForValue(val);
                  return label; // redan formaterat som "Tis 29 juli"
                }
              },
              grid: { display: false }
            },
            y: { display: false }
        }
        }
      });
    } catch (err) {
      console.warn("Kunde inte ladda visningsdiagram:", err.message);
    }
  }

  document.addEventListener("DOMContentLoaded", renderPageViewChart);
</script>

  <script>
  let isAsking = false;

  async function askAI() {
  if (isAsking) return;        // üîí Blockera om en fr√•ga redan p√•g√•r
  isAsking = true;

  const message = document.getElementById("aiMessage").value.trim();
  const responseDiv = document.getElementById("aiResponse");

  if (!message) {
    responseDiv.textContent = "‚ö†Ô∏è V√§nligen skriv en fr√•ga f√∂rst.";
    isAsking = false;
    return;
  }

  responseDiv.innerHTML = '<div id="loadingAnimation" class="loader"></div>';

  try {
    const res = await fetch("/api/chat/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
      credentials: "include"
    });

    const data = await res.json();
    const reply = data.reply || "‚ùå Inget svar fr√•n AI.";

      responseDiv.innerHTML = "";
const paragraphs = reply.split('\n\n'); // Dela upp i stycken
let i = 0;
const delay = 200; // Millisekunder mellan varje stycke

function typeParagraph() {
  if (i < paragraphs.length) {
    const p = document.createElement('p');
    p.textContent = paragraphs[i];
    responseDiv.appendChild(p);
    i++;
    setTimeout(typeParagraph, delay);
    isAsking = false;
  }
}

typeParagraph();


    } catch (err) {
      responseDiv.textContent = "‚ùå Det gick inte att kontakta AI-agenten.";
      console.error(err);
    }
  }

  const textarea = document.getElementById("aiMessage");
  textarea.addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      askAI();
    }
  });
</script>
<script>
window.customerId = null;

async function fetchCustomerId() {
  try {
    const res = await fetch("/api/profile/me", { credentials: "include" });
    const data = await res.json();
    console.log("üë§ /api/profile/me svar:", data); // DEBUG

    if (!res.ok || !data.success || !data._id) {
      console.warn("‚ùå Kunde inte h√§mta kund-ID");
      window.customerId = null;
      return null;
    }

    window.customerId = data._id;
    return data._id;
  } catch (err) {
    console.warn("‚ùå Kunde inte h√§mta kund-ID:", err.message);
    window.customerId = null;
    return null;
  }
}


  async function loadSupportHistory() {
  try {
    const res = await fetch("/api/profile/me", { credentials: "include" });
    const data = await res.json();

    const tbody = document.querySelector(".support-table tbody");
    if (!tbody) return;

    const history = data.supportHistory || [];

    if (history.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="5">Inga tidigare √§renden hittades.</td></tr>
      `;
      return;
    }

    // Rensa gammal data
    tbody.innerHTML = "";

    // Sortera nyast f√∂rst
    history.sort((a, b) => new Date(b.date) - new Date(a.date));

    for (const item of history) {
      const tr = document.createElement("tr");

      const formattedDate = new Date(item.date).toLocaleDateString("sv-SE", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });

      tr.innerHTML = `
       <td>${item.caseId || "-"}</td>
        <td>${formattedDate}</td>
        <td>${data.name || "Ok√§nd"}</td>
        <td>${item.topic}</td>
        <td><span class="status-text ${item.status.toLowerCase().replace(/\s/g, '')}">${item.status}</span></td>
      `;

      tbody.appendChild(tr);
    }
  } catch (err) {
    console.error("‚ùå Kunde inte h√§mta supporthistorik:", err);
  }
}


document.addEventListener("DOMContentLoaded", async () => {
  const id = await fetchCustomerId(); // v√§nta tills ID finns
  loadSupportHistory();               // kan k√∂ras oavsett
  if (id) {
    loadAIInsights();                 // k√∂rs bara om vi fick ID
  }
});



</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chatBtn = document.getElementById("startChatBtn");
    const chatWindow = document.getElementById("chatWindow");

    if (chatBtn && chatWindow) {
      chatBtn.addEventListener("click", () => {
        chatWindow.style.display = "block";
      });
    }
  });
</script>


<!-- ... Resten av filen (chatWindow-div, scripts, avslutande taggar) ... -->

<div id="chatWindow" style="display:none; position:fixed; bottom:20px; right:20px; width:300px; height:400px; background:#fff; border:1px solid #ccc; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); z-index:1000; padding:10px;">
  <h4>Chatt med support</h4>
  <div id="chatMessages" style="height:300px; overflow-y:auto; margin-bottom:10px;"></div>
  <form id="chatForm">
    <input type="text" id="chatInput" placeholder="Skriv ett meddelande..." style="width:100%; padding:5px;" />
  </form>  

</div>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/chat.js"></script>


<!-- Din hamburgermenyfunktion (redan inlagd) -->
<script>
  const menuBtn = document.getElementById('menuToggle');
  const sidebar = document.querySelector('.sidebar');

  menuBtn.addEventListener('click', () => {
    const isActive = sidebar.classList.toggle('active');
    document.body.classList.toggle('menu-open', isActive);
  });

  window.addEventListener('click', (e) => {
    const isClickInsideMenu = sidebar.contains(e.target);
    const isClickOnToggle = menuBtn.contains(e.target);
    const isMobile = window.innerWidth <= 768;

    if (!isClickInsideMenu && !isClickOnToggle && isMobile) {
      sidebar.classList.remove('active');
      document.body.classList.remove('menu-open');
    }
  });
</script>

<!-- üîß L√ÑGG IN showToast H√ÑR -->
<script>
  function showToast(message) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;

    container.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
</script>

<!-- Toast-container -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

</body>
</html>

<script>
  document.getElementById("chatForm").addEventListener("submit", function (e) {
    e.preventDefault(); // stoppar reload
    sendMessage();      // fr√•n chat.js
  });
</script>
<script>
  const toggle = document.getElementById('profileToggle');
  const menu = document.getElementById('profileMenu');

  toggle.addEventListener('click', () => {
    const isOpen = menu.style.display === 'flex';
    menu.style.display = isOpen ? 'none' : 'flex';
    toggle.classList.toggle('open', !isOpen);
  });

  window.addEventListener('click', function (e) {
    if (!document.querySelector('.profile-wrapper').contains(e.target)) {
      menu.style.display = 'none';
      toggle.classList.remove('open');
    }
  });

  document.getElementById("switchAccount").addEventListener("click", function (e) {
    e.preventDefault();
    if (confirm("Vill du logga ut och byta konto?")) {
      window.location.href = "login.html";
    }
  });

  document.getElementById("openSettings").addEventListener("click", function (e) {
    e.preventDefault();
    window.location.href = "profile.html";
  });

  async function loadUserProfile() {
    try {
      const res = await fetch("/api/auth/me", { credentials: "include" });
      const data = await res.json();

      if (data.success) {
        const name = data.name || '';
        const email = data.email || '';
        const image = data.profileImage;

        if (image) {
          document.getElementById("profileToggle").innerHTML = `
            <img src="${image}" alt="Profilbild" style="width: 32px; height: 32px; border-radius: 50%;" />
          `;
        } else {
          const initials = name
            .split(' ')
            .map(part => part.charAt(0).toUpperCase())
            .join('')
            .substring(0, 2);
            if (!name) return;
          document.getElementById("profileToggle").textContent = initials;
        }

        document.getElementById("userEmail").textContent = email;
      } else {
        document.getElementById("profileToggle").textContent = "??";
        document.getElementById("userEmail").textContent = "Ej inloggad";
      }
    } catch (err) {
      console.error("Fel vid h√§mtning av anv√§ndarprofil:", err);
    }
  }

  loadUserProfile();
</script>


<script>
  async function fetchPageViewInsights() {
    try {
      const res = await fetch("/api/pageviews/summary", { credentials: "include" });
      const data = await res.json();

      const today = data.todaysCount || 0;
      const weekBefore = data.counts[0] || 0;
      const percent = weekBefore > 0 ? Math.round(((today - weekBefore) / weekBefore) * 100) : null;

      document.getElementById("todayCount").innerHTML = `<strong>${today} visningar idag</strong>`;

      const changeElem = document.getElementById("change");
      if (percent === null) {
        changeElem.textContent = "Ingen j√§mf√∂relsedata √§nnu";
        changeElem.style.color = "#10b981"; // gr√∂n
      } else {
        const sign = percent >= 0 ? "+" : "";
        changeElem.textContent = `${sign}${percent}% senaste veckan`;
        changeElem.style.color = percent >= 0 ? "#10b981" : "#ef4444"; // gr√∂n eller r√∂d
      }
    } catch (err) {
      console.warn("Kunde inte h√§mta sidvisningsdata:", err.message);
    }
  }

  document.addEventListener("DOMContentLoaded", fetchPageViewInsights);
</script>
<script>
  const ctx = document.getElementById('salesChart')?.getContext('2d');
  if (ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['M√•n', 'Tis', 'Ons', 'Tors', 'Fre', 'L√∂r', 'S√∂n'],
        datasets: [{
          label: 'F√∂rs√§ljning (SEK)',
          data: [120000, 95000, 110000, 87000, 98000, 102000, 140000],
          backgroundColor: '#111827'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#6b7280' } },
          y: {
            beginAtZero: true,
            ticks: { color: '#6b7280' }
          }
        }
      }
    });
  } else {
    console.error("üõë Kunde inte hitta elementet #salesChart");
  }
</script>
<script>
  async function loadAIInsights() {
    const container = document.getElementById("aiInsightsContent");
    if (!window.customerId) {
      container.textContent = "Kunde inte ladda kunddata.";
      return;
    }
  
    try {
      // 1) F√∂rs√∂k h√§mta sparade insikter
      let res = await fetch(`/api/insights/by-customer/${window.customerId}`, {
        credentials: "include"
      });
      let data = await res.json();
  
      // 2) Om det inte finns n√•gra: trigga generering och h√§mta resultatet
      if (!data?.success || !Array.isArray(data.insights) || data.insights.length === 0) {
        container.innerHTML = "<p>Genererar AI-insikter‚Ä¶</p>";
  
        const genRes = await fetch(`/api/insights/${window.customerId}`, {
          credentials: "include"
        });
        const genData = await genRes.json();
  
        if (Array.isArray(genData.insights) && genData.insights.length > 0) {
          data = { success: true, insights: genData.insights };
        } else {
          container.innerHTML = "<p>Inga AI-insikter √§nnu.</p>";
          return;
        }
      }
  
      // 3) Rendera insikter
      const colors = {
        "Annonsering": "#E3F2FD",
        "Konvertering": "#FCE4EC",
        "Strategi": "#E8F5E9",
        "Engagemang": "#FFF8E1"
      };
  
      container.innerHTML = "";
      data.insights.forEach(tip => {
        const card = document.createElement("div");
        card.style.border = "1px solid #ccc";
        card.style.borderRadius = "1rem";
        card.style.padding = "1rem";
        card.style.marginBottom = "1rem";
        card.style.backgroundColor = colors[tip.category] || "#f4f4f4";
  
        card.innerHTML = `
          <h4>${tip.title ?? ""} ${tip.priority ? "üî•" : ""}</h4>
          <p><strong>Kategori:</strong> ${tip.category ?? "-"}</p>
          <p><strong>Varf√∂r:</strong> ${tip.reason ?? "-"}</p>
          <p><strong>√Ötg√§rd:</strong> ${tip.action ?? "-"}</p>
        `;
        container.appendChild(card);
      });
  
    } catch (err) {
      console.error("‚ùå Kunde inte ladda/generera AI-insikter:", err);
      container.innerHTML = "<p>Fel vid h√§mtning av insikter.</p>";
    }
  }
  </script>
  
<script src="/js/logout.js"></script>

</body>
</html>
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Min Profil</title>
  <link rel="stylesheet" href="CSS/profile.css" />
</head>
<body>
  <div class="container">
    <h1>Min profil</h1>

    <div class="profile-layout">
      <main class="profile-content">
        <!-- Header-kortet -->
        <section class="profile-header">
          <div class="ph-left">
            <button type="button" class="avatar" id="avatarBtn" aria-label="Byt profilbild" title="Byt profilbild" style="cursor:pointer;">
              <img id="profileAvatar" src="" alt="Profilbild"/>
            </button>            
            <div class="identity">
              <div class="badges" id="planBadges"></div>
              <h2 id="profileName" class="display-name">—</h2>
              <div id="profileEmail" class="muted">—</div>
            </div>
          </div>
          <button type="button" class="edit-link" id="editProfileBtn">✎ Redigera</button>
        </section>

        <!-- Flikar (visuell, en panel just nu) -->
        <nav class="tabs" aria-label="Profilflikar">
          <button class="tab active" data-tab="details">Profiluppgifter</button>
          <button class="tab" data-tab="settings">Inställningar</button>

        </nav>

        <!-- Panel med formulär (två kolumner) -->
        <section class="panel">
          <form id="profileForm" class="grid-2">
            <!-- Namn / E-post -->
            <div class="field">
              <label for="fullname">Namn</label>
              <input type="text" id="fullname" />
            </div>

            <div class="field">
              <label for="email">E-post</label>
              <input type="email" id="email" />
            </div>

            <!-- Språk / Lösenord -->
            <div class="field">
              <label for="language">Språk</label>
              <select id="language">
                <option value="sv">Svenska</option>
                <option value="en">Engelska</option>
              </select>
            </div>

            <div class="field">
              <label for="password">Nytt lösenord</label>
              <input type="password" id="password" placeholder="********" />
            </div>

            <!-- Profilbild (spänner över två kolumner) -->
            <div class="field span-2">
              <label for="profilePic">Profilbild</label>
              <input type="file" id="profilePic" name="profilePic" accept="image/*" />
              <div id="profilePicStatus" class="hint" style="margin-top:6px;"></div>

              <div class="profile-pic-preview">
                <img id="profilePicPreview" src="" alt="" />
                <button type="button" id="removePicBtn" class="remove-btn">Ta bort bild</button>
              </div>
            </div>

            <!-- Actions längst ned höger -->
            <div class="actions span-2">
              <button type="submit" class="primary">Spara</button>
            </div>
          </form>
          <p id="saveMessage"></p>
        </section>
      </main>
      <!-- Inställningar-panel (börjar dold) -->
<section class="panel" id="settingsPanel" hidden>
  <form id="settingsForm" class="grid-2">
    <div class="field">
      <label>Tvåfaktorsinloggning (TOTP)</label>
      <div class="value-muted" id="twofaStatus">Läser status…</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" id="setup2faBtn" class="primary">Aktivera/Återställ 2FA</button>
        <button type="button" id="regenBackupCodesBtn" class="secondary" disabled>Skapa nya reservkoder</button>
      </div>
    </div>
    

    <div class="field">
      <label>Fakturering & paket</label>
      <div class="hint">Ditt paket visas överst. Hantera betalningar i kundportalen.</div>
      <div style="margin-top:8px;">
        <button type="button" id="billingPortalBtn" class="primary">Hantera fakturering</button>
      </div>
    </div>
  </form>
  <p id="settingsMessage"></p>
</section>

    </div>
  </div>
<!-- TOTP-Modal -->
<div id="twofaModal" hidden
     style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:1000;">
  <div style="background:#fff;border-radius:12px;max-width:420px;width:92%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
    <h3 style="margin:0 0 10px;">Aktivera tvåfaktorsinloggning</h3>
    <p class="hint" style="margin:0 0 12px;">1) Skanna QR med din Authenticator-app (Google/Microsoft/Authy). 2) Skriv in koden nedan.</p>

    <div style="display:flex;gap:16px;align-items:center;margin:10px 0 14px;">
      <img id="twofaQr" alt="QR-kod" style="width:140px;height:140px;border:1px solid #e5e7eb;border-radius:8px;object-fit:contain;background:#fff"/>
      <div style="flex:1;">
        <label for="twofaToken" style="display:block;margin-bottom:6px;font-weight:600;">6-siffrig kod</label>
        <input id="twofaToken" type="text" inputmode="numeric" pattern="[0-9]*"
               style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:16px;" />
        <div id="twofaMsg" class="hint" style="margin-top:8px;"></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button type="button" id="twofaCancelBtn" class="back-btn">Avbryt</button>
      <button type="button" id="twofaVerifyBtn" class="primary">Verifiera & aktivera</button>
    </div>

    <!-- Backupkoder visas här efter aktivering -->
    <div id="backupCodesBox" style="margin-top:16px;display:none;">
      <h4 style="margin:0 0 8px;">Reservkoder</h4>
      <p class="hint" style="margin:0 0 10px;">Spara dessa koder på en säker plats. Varje kod kan användas en gång.</p>
      <pre id="backupCodesList" style="max-height:160px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px;"></pre>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" id="downloadBackupCodesBtn" class="secondary">Ladda ned .txt</button>
        <button type="button" id="closeModalAfterBackup" class="primary">Stäng</button>
      </div>
    </div>
  </div>
</div>

  <script>
    // ======= Befintlig logik + header/paket-badge =======
    let removeImage = false;

    // Rendera paket-badge (Bas/Grower/Enterprise) med färger via CSS-klasser
    function renderPlanBadge(plan){
      const c = document.getElementById('planBadges');
      if (!c) return;
      c.innerHTML = ''; // nollställ

      let cls = 'unknown', text = 'Okänt paket';
      if (plan) {
        const p = (''+plan).toLowerCase();
        if (p === 'bas') { cls = 'bas'; text = 'Bas'; }
        else if (p === 'grower') { cls = 'grower'; text = 'Grower'; }
        else if (p === 'enterprise') { cls = 'enterprise'; text = 'Enterprise'; }
      }
      const span = document.createElement('span');
      span.className = `badge ${cls}`;
      span.textContent = text;
      c.appendChild(span);
    }
    // Flikväxling
(function(){
  const tabs = document.querySelectorAll('.tabs .tab');
  const detailsPanel = document.querySelector('.panel');          // första panelen = profiluppgifter
  const settingsPanel = document.getElementById('settingsPanel'); // nya panelen

  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      if (btn.dataset.tab === 'settings') {
        detailsPanel.hidden = true;
        settingsPanel.hidden = false;
      } else {
        detailsPanel.hidden = false;
        settingsPanel.hidden = true;
      }
    });
  });
})();
// Billing portal (Stripe) – backend ska svara {url}
document.getElementById('billingPortalBtn')?.addEventListener('click', async ()=>{
  try{
    const t = await (await fetch('/csrf-token',{credentials:'include'})).json();
    const r = await fetch('/api/billing/customer-portal',{
      method:'POST',credentials:'include',
      headers:{'Content-Type':'application/json','CSRF-Token':t?.csrfToken},
      body: JSON.stringify({})
    });
    const j = await r.json();
    if(r.ok && j?.url) location.href = j.url;
    else alert('Kunde inte öppna fakturering.');
  }catch(_){ alert('Tekniskt fel.'); }
});

// === TOTP/2FA UI & API ===
async function getCsrf() {
  // Prova /csrf-token först (du använder den redan), fall back till /auth/csrf
  const tryUrls = ['/csrf-token', '/auth/csrf', '/csrf'];
  for (const url of tryUrls) {
    try {
      const r = await fetch(url, { credentials: 'include' });
      if (!r.ok) continue;
      const j = await r.json();
      if (j?.csrfToken) return j.csrfToken;
    } catch(_) {}
  }
  throw new Error('Hittar ingen CSRF-token');
}


async function refreshTwofaStatus() {
  try {
    const res = await fetch('/api/security/2fa/status', { credentials: 'include' });
    const data = await res.json();
    const el = document.getElementById('twofaStatus');
    const regenBtn = document.getElementById('regenBackupCodesBtn');
    if (!res.ok) throw new Error(data?.message || 'Kunde inte läsa status');

    const enabled = !!data.enabled;
    el.textContent = enabled ? 'Aktiverad' : 'Inte aktiverad';

    // Aktivera/avaktivera knappen för reservkoder
    if (regenBtn) {
      regenBtn.disabled = !enabled;
      regenBtn.classList.toggle('disabled', !enabled);
    }
  } catch (e) {
    console.error('2FA-status fel:', e);
    const el = document.getElementById('twofaStatus');
    if (el) el.textContent = 'Kunde inte läsa status';
  }
}

async function openTwofaModal() {
  try {
    const token = await getCsrf();
    const res = await fetch('/api/security/2fa/totp/init', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': token },
      body: JSON.stringify({})
    });
    const data = await res.json();
    if (!res.ok || !data?.qr) throw new Error(data?.message || 'Kunde inte initiera 2FA');

    document.getElementById('twofaQr').src = data.qr;
    document.getElementById('twofaToken').value = '';
    document.getElementById('twofaMsg').textContent = '';
    document.getElementById('backupCodesBox').style.display = 'none';
    document.getElementById('twofaModal').hidden = false;
    setTimeout(()=>document.getElementById('twofaToken').focus(), 50);
  } catch (e) {
    alert('Kunde inte starta TOTP-setup.');
    console.error(e);
  }
}

async function verifyTwofaAndShowBackups() {
  try {
    const token = await getCsrf();
    const code = (document.getElementById('twofaToken').value || '')
  .replace(/\s+/g,'')     // ta bort mellanrum
  .replace(/[^0-9]/g,'')  // behåll bara siffror
  .trim();
    if (!code) {
      document.getElementById('twofaMsg').textContent = 'Ange koden från din app.';
      return;
    }

    const res = await fetch('/api/security/2fa/totp/verify', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': token },
      body: JSON.stringify({ token: code })
    });
    const data = await res.json();
    if (!res.ok || !Array.isArray(data?.backupCodes)) {
      document.getElementById('twofaMsg').textContent = data?.message || 'Felaktig kod. Försök igen.';
      return;
    }

    // Visa backupkoder
    const list = data.backupCodes.join('\n');
    document.getElementById('backupCodesList').textContent = list;
    document.getElementById('backupCodesBox').style.display = 'block';
    document.getElementById('twofaMsg').textContent = '✅ 2FA är aktiverad. Spara koderna nedan.';
    await refreshTwofaStatus();
  } catch (e) {
    console.error(e);
    document.getElementById('twofaMsg').textContent = 'Tekniskt fel.';
  }
}

function closeTwofaModal() {
  document.getElementById('twofaModal').hidden = true;
}

// Ladda ned backupkoder som textfil
function downloadBackupCodes() {
  const text = document.getElementById('backupCodesList').textContent || '';
  const blob = new Blob([text + '\n'], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'source-backupkoder.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// Regenerera reservkoder (kräver att 2FA redan är aktiv)
async function regenerateBackupCodes() {
  try {
    const token = await getCsrf();
    const res = await fetch('/api/security/2fa/backup-codes/regenerate', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', 'CSRF-Token': token },
      body: JSON.stringify({})
    });
    const data = await res.json();
    if (!res.ok || !Array.isArray(data?.backupCodes)) {
      alert(data?.message || 'Kunde inte skapa nya koder.');
      return;
    }
    // Visa modal direkt med nya koder
    document.getElementById('twofaQr').src = '';
    document.getElementById('twofaToken').value = '';
    document.getElementById('twofaMsg').textContent = 'Nya reservkoder skapade.';
    const list = data.backupCodes.join('\n');
    document.getElementById('backupCodesList').textContent = list;
    document.getElementById('backupCodesBox').style.display = 'block';
    document.getElementById('twofaModal').hidden = false;
  } catch (e) {
    console.error(e);
    alert('Tekniskt fel vid skapande av nya koder.');
  }
}

// Hooka knappar
document.getElementById('setup2faBtn')?.addEventListener('click', openTwofaModal);
document.getElementById('twofaVerifyBtn')?.addEventListener('click', verifyTwofaAndShowBackups);
document.getElementById('twofaCancelBtn')?.addEventListener('click', closeTwofaModal);
document.getElementById('closeModalAfterBackup')?.addEventListener('click', closeTwofaModal);
document.getElementById('downloadBackupCodesBtn')?.addEventListener('click', downloadBackupCodes);
document.getElementById('regenBackupCodesBtn')?.addEventListener('click', regenerateBackupCodes);

// Öppna filväljaren och säkerställ att "Profiluppgifter"-fliken är aktiv
function openProfilePicPicker() {
  const detailsTab = document.querySelector('.tabs .tab[data-tab="details"]');
  const settingsPanel = document.getElementById('settingsPanel');
  const detailsPanel = document.querySelector('.panel'); // första panelen

  // Växla till Profiluppgifter om nödvändigt
  if (detailsTab && !detailsTab.classList.contains('active')) {
    detailsTab.click();
  } else {
    // ifall flikscriptet inte hunnit initiera: säkerställ visning
    if (detailsPanel) detailsPanel.hidden = false;
    if (settingsPanel) settingsPanel.hidden = true;
  }

  const input = document.getElementById('profilePic');
  if (input) {
    // Fokusera utan scroll (behagligt) och öppna dialogen
    try { input.focus({ preventScroll: true }); } catch(_) {}
    input.click();
  }
}

// Koppla klick på "Redigera" och avatar
document.getElementById('editProfileBtn')?.addEventListener('click', openProfilePicPicker);
document.getElementById('avatarBtn')?.addEventListener('click', openProfilePicPicker);


    async function loadProfile() {
      try {
        const res = await fetch('/api/profile/me', { credentials: 'include' });
        if (!res.ok) throw new Error("Kunde inte hämta profil");

        const user = await res.json();

        // Fyll formulär
        document.getElementById('fullname').value = user.name || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('language').value = user.language || 'sv';

        // Header: namn/e-post
        document.getElementById('profileName').textContent = user.name || '—';
        document.getElementById('profileEmail').textContent = user.email || '—';

        // Paketbadge från flera möjliga fältnamn (plan/package/subscription)
        const plan = user.plan || user.package || user.subscription || null;
        renderPlanBadge(plan);

        // Profilbild (preview + avatar i header)
        const preview = document.getElementById("profilePicPreview");
        const removeBtn = document.getElementById("removePicBtn");
        const statusEl = document.getElementById("profilePicStatus");
        const avatar = document.getElementById("profileAvatar");

        if (user.profileImage) {
          preview.src = user.profileImage;
          preview.style.display = "block";
          removeBtn.style.display = "inline";
          avatar.src = user.profileImage;
          if (statusEl) statusEl.textContent = "En profilbild finns sparad (ersätts om du laddar upp en ny).";
        } else {
          preview.style.display = "none";
          removeBtn.style.display = "none";
          avatar.removeAttribute('src'); // låt CSS/placeholder gälla
          if (statusEl) statusEl.textContent = "Ingen profilbild är sparad ännu.";
        }
      } catch (err) {
        console.error("❌ Fel vid inladdning av profil:", err);
        document.getElementById('saveMessage').textContent = "❌ Kunde inte ladda profilen.";
      }
    }

    // Byt bild => uppdatera preview + header-avatar
    document.getElementById("profilePic").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const preview = document.getElementById("profilePicPreview");
      const removeBtn = document.getElementById("removePicBtn");
      const statusEl = document.getElementById("profilePicStatus");
      const avatar = document.getElementById("profileAvatar");

      if (file) {
        const url = URL.createObjectURL(file);
        preview.src = url;
        avatar.src = url;
        preview.style.display = "block";
        removeBtn.style.display = "inline";
        removeImage = false;
        if (statusEl) statusEl.textContent = `Vald fil: ${file.name} (ersätter sparad bild när du sparar).`;
      } else {
        if (statusEl) statusEl.textContent = "Ingen fil vald.";
      }
    });

    // Ta bort bild
    document.getElementById("removePicBtn").addEventListener("click", () => {
      if (confirm("Vill du ta bort din profilbild?")) {
        const preview = document.getElementById("profilePicPreview");
        const fileInput = document.getElementById("profilePic");
        const removeBtn = document.getElementById("removePicBtn");
        const statusEl = document.getElementById("profilePicStatus");
        const avatar = document.getElementById("profileAvatar");

        preview.src = "";
        preview.style.display = "none";
        fileInput.value = "";
        removeBtn.style.display = "none";
        avatar.removeAttribute('src');
        removeImage = true;

        if (statusEl) statusEl.textContent = "Bild kommer att tas bort när du sparar.";
      }
    });

    // Spara
    document.getElementById("profileForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const name = document.getElementById('fullname').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const language = document.getElementById('language').value;
      const profilePic = document.getElementById('profilePic').files[0];

      const confirmed = confirm("Är du säker på att du vill spara dessa ändringar?");
      if (!confirmed) return;

      // CSRF-token
      let csrfToken;
      try {
        const tRes = await fetch('/csrf-token', { credentials: 'include' });
        const tData = await tRes.json();
        csrfToken = tData?.csrfToken;
        if (!csrfToken) throw new Error('Saknar CSRF-token i svar');
      } catch (err) {
        console.error('CSRF-token fel:', err);
        document.getElementById('saveMessage').textContent = "❌ Kunde inte hämta säkerhetstoken. Prova igen.";
        return;
      }

      const formData = new FormData();
      formData.append("name", name);
      formData.append("email", email);
      formData.append("password", password);
      formData.append("language", language);
      formData.append("removeImage", removeImage);
      if (profilePic) formData.append("profilePic", profilePic);

      try {
        const res = await fetch("/api/profile/update", {
          method: "POST",
          body: formData,
          credentials: "include",
          headers: { "CSRF-Token": csrfToken }
        });

        const data = await res.json();
        if (res.ok && data.success) {
          document.getElementById('saveMessage').textContent = "✅ Ändringar sparade!";
        } else {
          const msg = (data && (data.message || data.error))
            ? (data.message || data.error)
            : `Det gick inte att spara (status ${res.status}).`;
          document.getElementById('saveMessage').textContent = `⚠️ ${msg}`;
          console.error("❌ Upload misslyckades:", { status: res.status, data });
        }
      } catch (err) {
        console.error("Något gick fel:", err);
        document.getElementById('saveMessage').textContent = "❌ Fel vid uppdatering.";
      }
    });

   // Init
refreshTwofaStatus && refreshTwofaStatus();
loadProfile();
  </script>
</body>
</html>

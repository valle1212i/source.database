<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Min Profil</title>
  <link rel="stylesheet" href="CSS/profile.css" />
</head>
<body>
  <div class="container">
    <h1>Min profil</h1>
    <form id="profileForm">
      <label for="fullname">Namn:</label>
      <input type="text" id="fullname" />

      <label for="email">E-post:</label>
      <input type="email" id="email" />

      <label for="password">Nytt lösenord:</label>
      <input type="password" id="password" placeholder="********" />

      <label for="language">Språk:</label>
      <select id="language">
        <option value="sv">Svenska</option>
        <option value="en">Engelska</option>
      </select>

      <label for="profilePic">Profilbild:</label>
      <input type="file" id="profilePic" name="profilePic" accept="image/*" />
      <div id="profilePicStatus" style="margin:6px 0 0;color:#666;font-size:0.9em;"></div>

      <div class="profile-pic-preview">
        <img id="profilePicPreview" src="" alt="" />
        <button type="button" id="removePicBtn" class="remove-btn">Ta bort bild</button>
      </div>

      <button type="submit">Spara ändringar</button>
      <button type="button" class="back-btn" onclick="history.back()">← Tillbaka</button>
    </form>
    <p id="saveMessage"></p>
  </div>

  <script>
    let removeImage = false;

    async function loadProfile() {
      try {
        const res = await fetch('/api/profile/me');
        if (!res.ok) throw new Error("Kunde inte hämta profil");

        const user = await res.json();

        document.getElementById('fullname').value = user.name || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('language').value = user.language || 'sv';

        const preview = document.getElementById("profilePicPreview");
const removeBtn = document.getElementById("removePicBtn");
const statusEl = document.getElementById("profilePicStatus");

if (user.profileImage) {
  preview.src = user.profileImage;
  preview.style.display = "block";
  removeBtn.style.display = "inline";
  if (statusEl) statusEl.textContent = "En profilbild finns sparad (ersätts om du laddar upp en ny).";
} else {
  preview.style.display = "none";
  removeBtn.style.display = "none";
  if (statusEl) statusEl.textContent = "Ingen profilbild är sparad ännu.";
}
      } catch (err) {
        console.error("❌ Fel vid inladdning av profil:", err);
        document.getElementById('saveMessage').textContent = "❌ Kunde inte ladda profilen.";
      }
    }

    document.getElementById("profilePic").addEventListener("change", function (e) {
  const file = e.target.files[0];
  const preview = document.getElementById("profilePicPreview");
  const removeBtn = document.getElementById("removePicBtn");
  const statusEl = document.getElementById("profilePicStatus");

  if (file) {
    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";
    removeBtn.style.display = "inline";
    removeImage = false;
    if (statusEl) statusEl.textContent = `Vald fil: ${file.name} (ersätter sparad bild när du sparar).`;
  } else {
    if (statusEl) statusEl.textContent = "Ingen fil vald.";
  }
});

    document.getElementById("removePicBtn").addEventListener("click", () => {
  if (confirm("Vill du ta bort din profilbild?")) {
    const preview = document.getElementById("profilePicPreview");
    const fileInput = document.getElementById("profilePic");
    const removeBtn = document.getElementById("removePicBtn");
    const statusEl = document.getElementById("profilePicStatus");

    // Nollställ visning och markera för borttag vid sparning
    preview.src = "";
    preview.style.display = "none";
    fileInput.value = "";
    removeBtn.style.display = "none";
    removeImage = true;

    // Tydlig statusrad
    if (statusEl) statusEl.textContent = "Bild kommer att tas bort när du sparar.";
  }
});
  document.getElementById("profileForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const name = document.getElementById('fullname').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const language = document.getElementById('language').value;
    const profilePic = document.getElementById('profilePic').files[0];

    const confirmed = confirm("Är du säker på att du vill spara dessa ändringar?");
    if (!confirmed) return;

    // 1) Hämta CSRF-token
    let csrfToken;
    try {
      const tRes = await fetch('/csrf-token', { credentials: 'include' });
      const tData = await tRes.json();
      csrfToken = tData?.csrfToken;
      if (!csrfToken) throw new Error('Saknar CSRF-token i svar');
    } catch (err) {
      console.error('CSRF-token fel:', err);
      document.getElementById('saveMessage').textContent = "❌ Kunde inte hämta säkerhetstoken. Prova igen.";
      return;
    }

    // 2) Bygg formData som tidigare
    const formData = new FormData();
    formData.append("name", name);
    formData.append("email", email);
    formData.append("password", password);
    formData.append("language", language);
    formData.append("removeImage", removeImage);
    if (profilePic) formData.append("profilePic", profilePic);

    // 3) Skicka med token i header + cookies
    try {
      const res = await fetch("/api/profile/update", {
        method: "POST",
        body: formData,
        credentials: "include",
        headers: { "CSRF-Token": csrfToken }
      });

      const data = await res.json();
      if (res.ok && data.success) {
        document.getElementById('saveMessage').textContent = "✅ Ändringar sparade!";
            } else {
        const msg = (data && (data.message || data.error))
          ? (data.message || data.error)
          : `Det gick inte att spara (status ${res.status}).`;
        document.getElementById('saveMessage').textContent = `⚠️ ${msg}`;
        console.error("❌ Upload misslyckades:", { status: res.status, data });
      }
    } catch (err) {
      console.error("Något gick fel:", err);
      document.getElementById('saveMessage').textContent = "❌ Fel vid uppdatering.";
    }
  });
</script>

</body>
</html>

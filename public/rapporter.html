<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kundportal - Utbetalningsrapporter</title>
  <link rel="stylesheet" href="CSS/rapporter.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
</head>
<body>
 <div class="sidebar">
  <div class="logo">
    <a href="customerportal.html">
      <img src="images/logo.png" alt="Logotyp" class="logo-img" />
    </a>
  </div>
 <ul class="nav-menu">
  <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
  <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
  <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
  <li class="active"><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
  <li><a href="betalningslank.html"><i class="fas fa-link"></i> Betalningslänk</a></li>
  <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
  <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
  <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
  <li><a href="marknadsforing.html"><i class="fas fa-bullhorn"></i> Marknadsföring</a></li>
  <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
  <li><a href="installningar.html"><i class="fas fa-cog"></i> Inställningar</a></li>
</ul>
   <div class="help">
      <a href="faq.html" style="color:#9ca3af; text-decoration:none;">
        <i class="fas fa-circle-question"></i> Hjälp / FAQ
      </a>
    </div>
  </div>
  <div class="main">
    <div class="profile-wrapper">
  <div class="profile-icon" id="profileToggle">--</div>

  <div class="profile-dropdown" id="profileMenu">
    <div class="profile-email" id="userEmail">Laddar...</div>
    <hr />
    <a href="#" id="switchAccount">Byt konto</a>
    <a href="#" id="openSettings">Profilinställningar</a>
    <a href="#" id="logout">Logga ut</a>
  </div>
</div>

    <!-- Hamburgermeny för mobil -->
<button class="hamburger-menu" onclick="toggleSidebar()">☰</button>

<h2 class="page-title">Utbetalningsrapporter</h2>
    <a href="customerportal.html" class="back-button">← Tillbaka till översikt</a>
    <p class="info-text">Här visas senaste genomförda utbetalningar.</p>

    <div class="filters">
      <input type="text" id="searchInput" placeholder="Sök belopp eller datum...">
      <select id="statusFilter">
        <option value="all">Alla</option>
        <option value="genomförd">Genomförd</option>
        <option value="avvisad">Avvisad</option>
      </select>
      <input type="date" id="startDate">
      <button class="black-button" onclick="filterReports()">Filtrera</button>
      <button class="black-button" onclick="sortByDate()">Sortera efter datum</button>
      <button class="black-button" onclick="exportReports()">Exportera som Excel</button>
    </div>

    <div id="paymentsList">
      <!-- Exempelrapporter -->
      <div class="card">
        <div class="card-top">
          <div>
            <strong>Utbetalning</strong>
            <p class="amount">215 000 SEK</p>
          </div>
          <div class="status open">
            <i class="fas fa-check-circle"></i> Genomförd
          </div>
        </div>
        <div class="card-details">
          <p>Datum: 2025-06-25</p>
          <p>Referens-ID: UTXN-001</p>
        </div>
        <div class="actions">
          <button class="black-button" onclick='showReport({
            amount: "215 000 SEK",
            status: "Genomförd",
            date: "2025-06-25",
            id: "UTXN-001"
          })'>Visa detaljer</button>
        </div>
      </div>

      <div class="card">
        <div class="card-top">
          <div>
            <strong>Utbetalning</strong>
            <p class="amount">180 500 SEK</p>
          </div>
          <div class="status open">
            <i class="fas fa-check-circle"></i> Genomförd
          </div>
        </div>
        <div class="card-details">
          <p>Datum: 2025-06-18</p>
          <p>Referens-ID: UTXN-002</p>
        </div>
        <div class="actions">
          <button class="black-button" onclick='showReport({
            amount: "180 500 SEK",
            status: "Genomförd",
            date: "2025-06-18",
            id: "UTXN-002"
          })'>Visa detaljer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Utbetalningsdetaljer</h2>
      <div id="modalDetails"></div>
      <button class="black-button" onclick="exportPDF()">Exportera som PDF</button>
    </div>
  </div>

  <script>
    let currentReport = {};

    function showReport(report) {
  currentReport = report;

  const details = document.getElementById("modalDetails");
  // Rensa befintligt innehåll utan att tolka HTML
  details.textContent = "";

  const rows = [
    ["Belopp:", report.amount],
    ["Status:", report.status],
    ["Datum:", report.date],
    ["Referens-ID:", report.id],
  ];

  for (const [label, value] of rows) {
    const p = document.createElement("p");
    const strong = document.createElement("strong");
    strong.textContent = label + " ";
    p.appendChild(strong);
    p.appendChild(document.createTextNode(String(value ?? "")));
    details.appendChild(p);
  }

  document.getElementById("receiptModal").style.display = "block";
}

    function closeModal() {
      document.getElementById("receiptModal").style.display = "none";
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Utbetalningsrapport", 20, 20);
      doc.setFontSize(12);
      doc.text(`Belopp: ${currentReport.amount}`, 20, 35);
      doc.text(`Status: ${currentReport.status}`, 20, 45);
      doc.text(`Datum: ${currentReport.date}`, 20, 55);
      doc.text(`Referens-ID: ${currentReport.id}`, 20, 65);
      doc.save(`Utbetalning_${currentReport.id}.pdf`);
    }

    function filterReports() {
      alert("Filtreringslogik här");
    }

    function sortByDate() {
      alert("Sortering implementeras här");
    }

    function exportReports() {
      alert("Exportera till Excel implementeras här");
    }
  </script>
  <script>
  const toggle = document.getElementById('profileToggle');
  const menu = document.getElementById('profileMenu');

  toggle.addEventListener('click', () => {
    const isOpen = menu.style.display === 'flex';
    menu.style.display = isOpen ? 'none' : 'flex';
    toggle.classList.toggle('open', !isOpen);
  });

  window.addEventListener('click', function (e) {
    if (!document.querySelector('.profile-wrapper').contains(e.target)) {
      menu.style.display = 'none';
      toggle.classList.remove('open');
    }
  });

  document.getElementById("switchAccount").addEventListener("click", function (e) {
    e.preventDefault();
    if (confirm("Vill du logga ut och byta konto?")) {
      window.location.href = "login.html";
    }
  });

  document.getElementById("openSettings").addEventListener("click", function (e) {
    e.preventDefault();
    window.location.href = "profile.html";
  });

  async function loadUserProfile() {
    try {
      const res = await fetch("/api/profile/me");
      const data = await res.json();

      if (data.success) {
        const name = data.name || '';
        const email = data.email || '';
        const image = data.profileImage;

        if (image) {
  try {
    const u = new URL(image, window.location.origin);
    if (u.protocol === "http:" || u.protocol === "https:" || u.protocol === "data:") {
      const container = document.getElementById("profileToggle");
      container.textContent = "";
      const img = document.createElement("img");
      img.src = u.href;
      img.alt = "Profilbild";
      img.width = 32;
      img.height = 32;
      img.style.borderRadius = "50%";
      container.appendChild(img);
    } else {
      document.getElementById("profileToggle").textContent = "--";
    }
  } catch {
    document.getElementById("profileToggle").textContent = "--";
  }
} else {
          const initials = name
            .split(' ')
            .map(part => part.charAt(0).toUpperCase())
            .join('')
            .substring(0, 2);
          document.getElementById("profileToggle").textContent = initials;
        }

        document.getElementById("userEmail").textContent = email;
      } else {
        document.getElementById("profileToggle").textContent = "??";
        document.getElementById("userEmail").textContent = "Ej inloggad";
      }
    } catch (err) {
      console.error("Fel vid hämtning av användarprofil:", err);
    }
  }

  loadUserProfile();
</script>
<script>
  function toggleSidebar() {
    const sidebar = document.querySelector(".sidebar");
    const isActive = sidebar.classList.contains("active");

    sidebar.classList.toggle("active", !isActive);
    document.body.classList.toggle("menu-open", !isActive);
  }
</script>
<script>
  // Hantera hamburgermeny-klick
  document.getElementById("hamburgerBtn").addEventListener("click", function () {
    document.querySelector(".sidebar").classList.toggle("active");
    document.body.classList.toggle("menu-open");
  });
</script>
<script src="/js/logout.js"></script>
</body>
</html>

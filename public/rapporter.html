<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kundportal - Utbetalningsrapporter</title>

  <!-- TIDIGT: Tema (FOUC-skydd) -->
  <script>
    (function () {
      try {
        var t = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', t);
      } catch (e) {}
    })();
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="CSS/theme.css" />
  <link rel="stylesheet" href="CSS/rapporter.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- jsPDF (för exportPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/eW3r7cKk7vA2sSg6o2cU4G3L9A8f6Jg7V7i3F0f0q3w7QDi5jWeyq1HkL7qg3c0d1cR2qvq8cJ5Hnq2j0p2JQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- Hamburger (mobil) -->
  <button id="menuToggle" class="hamburger-menu" aria-label="Visa meny">☰</button>

  <!-- ===== SIDOMENY ===== -->
  <aside class="sidebar" aria-label="Sidomeny">
    <div class="logo">
      <a href="customerportal.html">
        <img src="images/logo.png" alt="Logotyp" class="logo-img" />
      </a>
    </div>

    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="betalningar.html"><i class="fas fa-credit-card"></i> Betalningar</a></li>
      <li><a href="kontakt.html"><i class="fas fa-envelope"></i> Kontakt</a></li>
      <li class="active"><a href="rapporter.html"><i class="fas fa-chart-line"></i> Rapporter</a></li>
      <li><a href="betalningslank.html"><i class="fas fa-link"></i> Betalningslänk</a></li>
      <li><a href="fakturor.html"><i class="fas fa-file-invoice"></i> Fakturor</a></li>
      <li><a href="kunder.html"><i class="fas fa-users"></i> Kunder</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-pie"></i> Analyser</a></li>
      <li><a href="marknadsforing.html"><i class="fas fa-bullhorn"></i> Marknadsföring</a></li>
      <li><a href="inventarier.html"><i class="fas fa-box"></i> Inventarier</a></li>
      <li><a href="installningar.html"><i class="fas fa-cog"></i> Inställningar</a></li>
    </ul>

    <div class="help">
      <a href="faq.html" style="color:#9ca3af; text-decoration:none;">
        <i class="fas fa-circle-question"></i> Hjälp / FAQ
      </a>
    </div>
  </aside>

  <div class="main">
    <div class="profile-wrapper">
      <div class="profile-icon" id="profileToggle">--</div>
      <div class="profile-dropdown" id="profileMenu">
        <div class="profile-email" id="userEmail">Laddar...</div>
        <hr />
        <a href="#" id="switchAccount">Byt konto</a>
        <a href="#" id="openSettings">Profilinställningar</a>
        <a href="#" id="logout">Logga ut</a>
      </div>
    </div>



    <h2 class="page-title">Utbetalningsrapporter</h2>
    <a href="customerportal.html" class="back-button">← Tillbaka till översikt</a>
    <p class="info-text">Här visas senaste genomförda utbetalningar.</p>

    <div class="filters">
      <input type="text" id="searchInput" placeholder="Sök belopp eller datum...">
      <select id="statusFilter">
        <option value="all">Alla</option>
        <option value="genomförd">Genomförd</option>
        <option value="avvisad">Avvisad</option>
      </select>
      <input type="date" id="startDate">
      <button class="black-button" onclick="filterReports()">Filtrera</button>
      <button class="black-button" onclick="sortByDate()">Sortera efter datum</button>
      <button class="black-button" onclick="exportReports()">Exportera som Excel</button>
    </div>

    <div id="paymentsList"></div>
  </div>

  <!-- Modal -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Utbetalningsdetaljer</h2>
      <div id="modalDetails"></div>
      <!-- Server-PDF -->
      <button id="pdfBtn" class="black-button" disabled>Ladda ner PDF</button>
    </div>
  </div>

  <script>
    /** ========= UTBETALNINGSRAPPORTER ========= **/
    const TENANT = 'vattentrygg';

    // DOM refs
    const listEl = document.getElementById('paymentsList');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const startDate = document.getElementById('startDate');
    const modal = document.getElementById('receiptModal');
    const modalDetails = document.getElementById('modalDetails');

    // State
    let allPayouts = [];
    let filtered = [];
    let nextCursor = null;
    let loading = false;

    // Helpers
    function minorToCurrency(n, cur='SEK'){
      const val = (Number(n||0)/100).toFixed(2);
      return `${val} ${cur?.toUpperCase?.() || 'SEK'}`;
    }
    function fmtDate(sec){ return sec ? new Date(sec*1000).toLocaleDateString('sv-SE') : '-' }
    function fmtDateTime(sec){ return sec ? new Date(sec*1000).toLocaleString('sv-SE') : '-' }

    function statusMap(s){
      switch (s) {
        case 'paid':       return { label: 'Genomförd', cls: 'open' };
        case 'canceled':   return { label: 'Avvisad',   cls: 'closed' };
        case 'pending':    return { label: 'Avvaktar',  cls: 'pending' };
        case 'in_transit': return { label: 'På väg',    cls: 'pending' };
        default:           return { label: s || 'Okänd', cls: 'pending' };
      }
    }

    function cardTemplate(p){
      const st = statusMap(p.status);
      return `
        <div class="card">
          <div class="card-top">
            <div>
              <strong>Utbetalning</strong>
              <p class="amount">${minorToCurrency(p.amount, p.currency)}</p>
            </div>
            <div class="status ${st.cls}">
              <i class="fas fa-check-circle"></i> ${st.label}
            </div>
          </div>
          <div class="card-details">
            <p>Datum: ${fmtDate(p.created)}</p>
            <p>Referens-ID: ${p.id}</p>
          </div>
          <div class="actions">
            <button class="black-button" data-open="${p.id}">Visa detaljer</button>
          </div>
        </div>
      `;
    }

    function renderList(){
      if (filtered.length === 0) {
        listEl.innerHTML = `<div class="card"><div class="card-details"><p>Inga utbetalningar ännu.</p></div></div>`;
        return;
      }
      listEl.innerHTML = filtered.map(cardTemplate).join('');
      listEl.querySelectorAll('button[data-open]').forEach(btn=>{
        const id = btn.getAttribute('data-open');
        btn.addEventListener('click', ()=> openDetail(id));
      });
    }

    function applyFilters(){
      const q = (searchInput.value || '').toLowerCase().trim();
      const st = statusFilter.value;
      const fromStr = startDate.value;

      filtered = allPayouts.filter(p=>{
        const label = statusMap(p.status).label.toLowerCase();
        if (st !== 'all') {
          if (st === 'genomförd' && label !== 'genomförd') return false;
          if (st === 'avvisad'   && label !== 'avvisad')   return false;
        }
        if (fromStr) {
          const fromMs = new Date(fromStr + 'T00:00:00').getTime();
          const pMs = (p.created || 0) * 1000;
          if (!(pMs >= fromMs)) return false;
        }
        if (q) {
          const hay = [
            String(p.id||'').toLowerCase(),
            fmtDate(p.created).toLowerCase(),
            minorToCurrency(p.amount, p.currency).toLowerCase()
          ].join(' | ');
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      renderList();
    }

    function sortByDate(){
      filtered.sort((a,b)=> (b.created||0) - (a.created||0));
      renderList();
    }

    // CSV-export (nuvarande vy)
    function exportReports(){
      if (filtered.length === 0) {
        alert('Inget att exportera.');
        return;
      }
      const rows = [['id','created','status_sv','amount','currency']];
      for (const p of filtered) {
        rows.push([
          p.id,
          fmtDateTime(p.created),
          statusMap(p.status).label,
          (Number(p.amount||0)/100).toFixed(2),
          (p.currency||'SEK').toUpperCase()
        ]);
      }
      const csv = rows.map(r => r.map(v=>{
        const s = String(v??'');
        return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(';')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `utbetalningar_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    window.exportReports = exportReports;

    // Server-PDF (centralt renderad)
    function downloadPayoutPdf(payoutId) {
      if (!payoutId) return alert('Ingen utbetalning vald.');
      const url = `/api/reports/payout/${encodeURIComponent(payoutId)}.pdf?tenant=${encodeURIComponent(TENANT)}`;
      window.open(url, '_blank', 'noopener');
    }

    // Modal-detalj
    async function openDetail(payoutId){
      try{
        const r1 = await fetch(`/api/payouts/${encodeURIComponent(payoutId)}`, {
          credentials: 'include',
          headers: { 'Accept':'application/json', 'X-Tenant': TENANT }
        });
        const d1 = await r1.json();
        const p = d1?.payout || {};

        const r2 = await fetch(`/api/payouts/${encodeURIComponent(payoutId)}/transactions`, {
          credentials: 'include',
          headers: { 'Accept':'application/json', 'X-Tenant': TENANT }
        });
        const d2 = await r2.json();
        const txns = Array.isArray(d2?.data) ? d2.data : [];

        let gross=0, fees=0, net=0;
        for (const t of txns) {
          gross += (t.amount||0);
          fees  += (t.fee||0);
          net   += (t.net||0);
        }

        modalDetails.textContent = '';
        const rows = [
          ['Utbetalning', p.id || '–'],
          ['Status', statusMap(p.status).label],
          ['Skapad', fmtDateTime(p.created)],
          ['Ankomst', fmtDateTime(p.arrival_date)],
          ['Belopp', minorToCurrency(p.amount, p.currency)],
          ['Brutto (txn)', minorToCurrency(gross, p.currency)],
          ['Avgifter (txn)', minorToCurrency(fees, p.currency)],
          ['Netto (txn)', minorToCurrency(net, p.currency)],
        ];
        for (const [label,val] of rows) {
          const pEl = document.createElement('p');
          const strong = document.createElement('strong');
          strong.textContent = label + ': ';
          pEl.appendChild(strong);
          pEl.appendChild(document.createTextNode(String(val ?? '')));
          modalDetails.appendChild(pEl);
        }

        if (txns.length > 0) {
          const tbl = document.createElement('table');
          tbl.style.width = '100%';
          tbl.style.borderCollapse = 'collapse';
          tbl.innerHTML = `
            <thead>
              <tr>
                <th style="text-align:left">Typ</th>
                <th style="text-align:left">Kategori</th>
                <th style="text-align:left">Datum</th>
                <th style="text-align:right">Belopp</th>
                <th style="text-align:right">Avgift</th>
                <th style="text-align:right">Netto</th>
                <th style="text-align:left">Källa</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tb = tbl.querySelector('tbody');
          for (const t of txns) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${t.type || '-'}</td>
              <td>${t.reporting_category || '-'}</td>
              <td>${fmtDateTime(t.created)}</td>
              <td style="text-align:right">${minorToCurrency(t.amount, t.currency)}</td>
              <td style="text-align:right">${minorToCurrency(t.fee, t.currency)}</td>
              <td style="text-align:right">${minorToCurrency(t.net, t.currency)}</td>
              <td><code>${t.source || ''}</code></td>
            `;
            tb.appendChild(tr);
          }
          modalDetails.appendChild(tbl);
        }

        // Visa modal
        modal.style.display = 'block';

        // Klient-PDF (lämnas kvar som alternativ)
        window.currentReport = {
          amount: minorToCurrency(p.amount, p.currency),
          status: statusMap(p.status).label,
          date: fmtDateTime(p.created),
          id: p.id,
          gross: minorToCurrency(gross, p.currency),
          fees: minorToCurrency(fees, p.currency),
          net: minorToCurrency(net, p.currency)
        };

        // Aktivera server-PDF-knapp
        const pdfBtn = document.getElementById('pdfBtn');
        pdfBtn.disabled = false;
        pdfBtn.onclick = () => downloadPayoutPdf(p.id);

      } catch(err){
        console.error('openDetail error', err);
        alert('Kunde inte ladda utbetalningsdetaljer.');
      }
    }

    function closeModal(){ modal.style.display = 'none'; }
    window.closeModal = closeModal;

    // Klient-PDF (behålls som extra)
    function exportPDF(){
      const rep = window.currentReport || null;
      if (!rep) return alert('Ingen rapport laddad ännu.');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('Utbetalningsrapport', 20, 20);
      doc.setFontSize(12);
      const lines = [
        `Utbetalning: ${rep.id}`,
        `Status: ${rep.status}`,
        `Datum: ${rep.date}`,
        `Belopp: ${rep.amount}`,
        `Brutto (txn): ${rep.gross}`,
        `Avgifter (txn): ${rep.fees}`,
        `Netto (txn): ${rep.net}`,
      ];
      let y = 35;
      lines.forEach(l => { doc.text(l, 20, y); y += 8; });
      doc.save(`Utbetalning_${rep.id}.pdf`);
    }
    window.exportPDF = exportPDF;

    // Ladda första sidan
    async function loadPayoutsPage(){
  if (loading) return;
  loading = true;
  try {
    const url = nextCursor ? `/api/payouts?starting_after=${encodeURIComponent(nextCursor)}` : '/api/payouts';
    const r = await fetch(url, {
      credentials: 'include',
      headers: { 'Accept':'application/json', 'X-Tenant': TENANT }
    });

    const text = await r.text();
    let data;
    try { data = JSON.parse(text); }
    catch {
      console.error('Upstream gav inte JSON:', text.slice(0,200));
      throw new Error('Kunde inte läsa data (ej JSON).');
    }

    const items = Array.isArray(data.data) ? data.data : [];
    allPayouts = allPayouts.concat(items);
    nextCursor = items.length > 0 ? items[items.length - 1].id : null;
    filtered = allPayouts.slice().sort((a,b)=> (b.created||0) - (a.created||0));
    renderList();
  } catch(e){
    console.error('loadPayoutsPage error', e);
    listEl.innerHTML = `<div class="card"><div class="card-details"><p>Kunde inte ladda utbetalningar.</p></div></div>`;
  } finally {
    loading = false;
  }
}


    // Filter-events
    document.querySelector('#statusFilter').addEventListener('change', applyFilters);
    document.querySelector('#searchInput').addEventListener('input', applyFilters);
    document.querySelector('#startDate').addEventListener('change', applyFilters);

    // Hamburgare
    document.querySelector(".hamburger-menu").addEventListener("click", function () {
      document.querySelector(".sidebar").classList.toggle("active");
      document.body.classList.toggle("menu-open");
    });

    // Start
    loadPayoutsPage();
  </script>

  <script src="/js/logout.js"></script>
</body>
</html>

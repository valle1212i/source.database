<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meta Ads ‚Äì Stegvis</title>
  <link rel="stylesheet" href="css/metaads.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="images/logo.png" alt="Logotyp" class="logo-img" />
    </div>
    <ul class="nav-menu">
      <li><a href="customerportal.html"><i class="fas fa-home"></i> Hem</a></li>
      <li><a href="googleads.html"><i class="fab fa-google"></i> Google Ads</a></li>
      <li class="active"><a href="metaads.html"><i class="fab fa-facebook"></i> Meta Ads</a></li>
      <li><a href="tiktokads.html"><i class="fab fa-tiktok"></i> TikTok Ads</a></li>
      <li><a href="linkedin.html"><i class="fab fa-linkedin"></i> Linkedin Ads</a></li>
      <li><a href="aimarknadsstudio.html"><i class="fas fa-magic"></i> AI Studio</a></li>
      <li><a href="radgivning.html"><i class="fas fa-headset"></i> R√•dgivning</a></li>
    </ul>
   <div class="help">
      <a href="faq.html" style="color:#9ca3af; text-decoration:none;">
        <i class="fas fa-circle-question"></i> Hj√§lp / FAQ
      </a>
    </div>
  </div>

  <div class="main-content">
    <a href="marknadsforing.html" class="back-link">‚Üê Tillbaka</a>

    <form id="stepForm">
      <div class="progress-text" id="progressText">Steg 1 av 7</div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- STEG 1 -->
      <div class="form-step active">
        <h2>1. Vilken typ av kampanj vill du skapa?</h2>
        <div class="options">
          <label><input type="radio" name="q1" value="R√§ckvidd" required> R√§ckvidd</label>
          <label><input type="radio" name="q1" value="Engagemang"> Engagemang</label>
          <label><input type="radio" name="q1" value="Konverteringar"> Konverteringar</label>
        </div>
        <div class="form-buttons">
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- STEG 2 -->
      <div class="form-step">
        <h2>2. Vilken √§r din m√•lgrupp?</h2>
        <div class="options">
          <label><input type="radio" name="q2" value="B2B" required> B2B</label>
          <label><input type="radio" name="q2" value="B2C"> B2C</label>
          <label><input type="radio" name="q2" value="Lokalt"> Lokalt</label>
        </div>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- STEG 3 -->
      <div class="form-step">
        <h2>3. Vad √§r ditt huvudm√•l?</h2>
        <div class="options">
          <label><input type="radio" name="huvudmal" value="Webbplatsbes√∂k" required> Webbplatsbes√∂k</label>
          <label><input type="radio" name="huvudmal" value="Meddelanden"> Meddelanden</label>
          <label><input type="radio" name="huvudmal" value="Appinstallationer"> Appinstallationer</label>
        </div>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- STEG 4 -->
      <div class="form-step">
        <h2>4. Vilken typ av media vill du annonsera med?</h2>
        <div class="options">
          <label><input type="radio" name="media" value="Bild" required> Bild</label>
          <label><input type="radio" name="media" value="Video"> Video</label>
          <label><input type="radio" name="media" value="Karusell"> Karusell</label>
        </div>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- STEG 5 -->
      <div class="form-step">
        <h2>5. Vad √§r din budgetniv√•?</h2>
        <div class="options">
          <label><input type="radio" name="budget" value="L√•g" required> L√•g</label>
          <label><input type="radio" name="budget" value="Medel"> Medel</label>
          <label><input type="radio" name="budget" value="H√∂g"> H√∂g</label>
        </div>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- STEG 6 -->
      <div class="form-step">
        <h2>6. Beskriv kort din verksamhet:</h2>
        <textarea name="verksamhet" required placeholder="T.ex. Vi s√§ljer ekologiska hudv√•rdsprodukter f√∂r k√§nslig hy."></textarea>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="button" onclick="nextStep()">N√§sta</button>
        </div>
      </div>

      <!-- STEG 7 -->
      <div class="form-step">
        <h2>7. Vad vill du att AI:n ska f√∂rmedla i din annons?</h2>
        <textarea name="budskap" required placeholder="T.ex. Visa att vi √§r ett h√•llbart alternativ med snabb leverans."></textarea>
        <div class="form-buttons">
          <button type="button" onclick="prevStep()">F√∂reg√•ende</button>
          <button type="submit">Skicka in</button>
        </div>
      </div>

      <!-- TACK -->
      <div class="form-step" id="thankYouStep">
        <h2>Tack f√∂r din f√∂rfr√•gan! üéâ</h2>
        <p style="margin-top: 16px; font-size: 16px; line-height: 1.6; text-align: center;">
          Din kampanjinfo har skickats till v√•ra experter.<br />
          Vi √•terkommer med ett Meta-f√∂rslag inom kort.<br />
          Du hittar f√∂rfr√•gan under <strong>Analyser</strong>.
        </p>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let currentStep = 0;
      const steps = document.querySelectorAll(".form-step");

      // CSRF-token (med cookies)
      let csrfTokenPromise = fetch("/csrf-token", { credentials: "include" })
        .then(r => r.ok ? r.json() : null)
        .then(d => d?.csrfToken || null)
        .catch(() => null);

      function updateProgressBar() {
        const total = steps.length - 1; // sista steget √§r tack
        const percent = Math.min((currentStep / total) * 100, 100);
        document.getElementById("progressBar").style.width = percent + "%";
        document.getElementById("progressText").innerText = `Steg ${Math.min(currentStep + 1, total)} av ${total}`;
      }

      function nextStep() {
        const current = steps[currentStep];
        const inputs = current.querySelectorAll("input, textarea");

        for (const input of inputs) {
          if (input.type === "radio") {
            const name = input.name;
            const group = current.querySelectorAll(`input[name="${name}"]`);
            if (![...group].some(i => i.checked)) {
              alert("V√§lj ett alternativ innan du g√•r vidare.");
              return;
            }
          } else if (input.tagName === "TEXTAREA" && input.value.trim() === "") {
            alert("Fyll i ett svar innan du g√•r vidare.");
            return;
          }
        }

        steps[currentStep].classList.remove("active");
        currentStep++;
        if (steps[currentStep]) {
          steps[currentStep].classList.add("active");
          updateProgressBar();
        }
      }

      function prevStep() {
        if (currentStep > 0) {
          steps[currentStep].classList.remove("active");
          currentStep--;
          steps[currentStep].classList.add("active");
          updateProgressBar();
        }
      }
      window.prevStep = prevStep;
      window.nextStep = nextStep;

      document.getElementById("stepForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const data = Object.fromEntries(new FormData(this).entries());

        // Mappa till backend/admin-format
        const payload = {
          marketing: {
            metaAds: {
              goals: data.huvudmal || data.q1 || "", // admin-HTML tittar p√• ".goals"
              campaignType: data.q1 || "",
              audience: data.q2 || "",
              objective: data.huvudmal || "",
              media: data.media || "",
              budget: data.budget || "",
              businessDesc: data.verksamhet || "",
              message: data.budskap || "",
              updatedAt: new Date().toISOString()
            }
          }
        };

        try {
          const token = await csrfTokenPromise;
          const res = await fetch("/api/customers/marketing/meta", {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
              ...(token ? { "x-csrf-token": token } : {})
            },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            let msg = `Serverfel ${res.status}`;
            try {
              const j = await res.json();
              if (j?.message || j?.error) msg = j.message || j.error;
            } catch {}
            throw new Error(msg);
          }

          // Visa tack
          steps[currentStep].classList.remove("active");
          currentStep++;
          if (steps[currentStep]) {
            steps[currentStep].classList.add("active");
            updateProgressBar();
          }
        } catch (err) {
          console.error("Fel vid inskickning:", err);
          alert("‚ùå Kunde inte skicka in formul√§ret. " + (err?.message || ""));
        }
      });

      updateProgressBar();
    });
  </script>
</body>
</html>
